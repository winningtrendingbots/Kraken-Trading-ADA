name: ğŸ¯ Train Encoder-Decoder LSTM

on:
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC diario
  workflow_dispatch:
    inputs:
      force_train:
        description: 'Force training'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  train-encoder-decoder:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Check model age
        id: check
        run: |
          echo "Checking Encoder-Decoder model age..."
          
          if [ "${{ github.event.inputs.force_train }}" = "true" ]; then
            echo "ğŸ”§ Force training enabled"
            echo "should_train=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -d "ADAUSD_MODELS" ] && [ -f "ADAUSD_MODELS/encoder_decoder_lstm.pth" ]; then
            last_train=$(stat -c %Y "ADAUSD_MODELS/encoder_decoder_lstm.pth")
            current_time=$(date +%s)
            age=$((current_time - last_train))
            days=$((age / 86400))
            
            echo "ğŸ“Š Model age: $days days"
            
            if [ $days -ge 7 ]; then
              echo "ğŸ”„ Retraining needed (â‰¥7 days)"
              echo "should_train=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Model still fresh ($days days)"
              echo "should_train=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Encoder-Decoder model not found"
            echo "should_train=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ Setup Python
        if: steps.check.outputs.should_train == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.check.outputs.should_train == 'true'
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§  Train Encoder-Decoder Model
        if: steps.check.outputs.should_train == 'true'
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "ğŸ”¥ ================================================"
          echo "   ENCODER-DECODER LSTM - OHLCV PREDICTION"
          echo "================================================"
          echo ""
          
          # Verify script
          SCRIPT_NAME=""
          if [ -f "adausd_encoder_decoder_lstm.py" ]; then
            SCRIPT_NAME="adausd_encoder_decoder_lstm.py"
          elif [ -f "encoder_decoder_lstm.py" ]; then
            SCRIPT_NAME="encoder_decoder_lstm.py"
          else
            echo "âŒ Error: Encoder-Decoder script not found"
            ls -la *.py 2>/dev/null || echo "No .py files in root"
            find . -name "*encoder*.py" -o -name "*decoder*.py" -type f
            exit 1
          fi
          
          echo "âœ… Script: $SCRIPT_NAME"
          echo ""
          echo "ğŸ—ï¸  ARCHITECTURE:"
          echo "   ğŸ”¹ Encoder: 3-layer Bi-LSTM (128 hidden)"
          echo "   ğŸ”¹ Decoder: 2-layer LSTM (128 hidden)"
          echo "   ğŸ”¹ Bahdanau Attention mechanism"
          echo "   ğŸ”¹ Teacher Forcing: 50%"
          echo "   ğŸ”¹ Autoregressive generation"
          echo ""
          echo "âœ¨ ADVANTAGES:"
          echo "   â€¢ Captures full sequence context"
          echo "   â€¢ Generates OHLCV step-by-step"
          echo "   â€¢ Learns OHLC constraints naturally"
          echo "   â€¢ Attention on relevant history"
          echo "   â€¢ Stabilized with teacher forcing"
          echo ""
          echo "âš™ï¸  CONFIG:"
          echo "   â€¢ SEQ_LEN: 90 (rich context)"
          echo "   â€¢ Hidden: 128 (high capacity)"
          echo "   â€¢ Batch: 64 (stable gradients)"
          echo "   â€¢ LR: 0.0001 (careful learning)"
          echo "   â€¢ Epochs: 250 (thorough training)"
          echo ""
          
          python "$SCRIPT_NAME"
          
          echo ""
          echo "âœ… Training completed"
      
      - name: ğŸ“Š Validate metrics
        if: steps.check.outputs.should_train == 'true'
        run: |
          echo ""
          echo "ğŸ” Validating Encoder-Decoder metrics..."
          
          if [ ! -f "ADAUSD_MODELS/config_encoder_decoder.json" ]; then
            echo "âŒ Config file not found"
            exit 0
          fi
          
          echo "âœ… Config found"
          echo ""
          echo "ğŸ“Š MODEL METRICS:"
          python3 <<'PYEOF'
import json
import sys

try:
    with open('ADAUSD_MODELS/config_encoder_decoder.json', 'r') as f:
        config = json.load(f)
    
    metrics = config.get('metrics_test', {})
    
    if not metrics:
        print("   âš ï¸ No metrics available")
        sys.exit(0)
    
    # Price targets
    price_targets = ['delta_open', 'delta_high', 'delta_low', 'delta_close']
    
    print("   ğŸ¯ PRICE (OHLC):")
    print("   Target          RÂ²        MAE       Accuracy")
    print("   -------------------------------------------------")
    
    price_r2_list = []
    price_acc_list = []
    
    for target in price_targets:
        if target in metrics:
            data = metrics[target]
            r2 = data.get('R2', 0)
            mae = data.get('MAE', 0)
            acc = data.get('Direction_Accuracy', 0)
            print(f"   {target:14} {r2:8.4f}   {mae:8.6f}   {acc:6.2f}%")
            price_r2_list.append(r2)
            price_acc_list.append(acc)
    
    if price_r2_list:
        avg_r2 = sum(price_r2_list) / len(price_r2_list)
        avg_acc = sum(price_acc_list) / len(price_acc_list)
        print(f"\n   ğŸ“ˆ Average Price RÂ²: {avg_r2:.4f}")
        print(f"   ğŸ¯ Average Price Accuracy: {avg_acc:.2f}%")
    
    # Volume
    if 'delta_volume' in metrics:
        vol = metrics['delta_volume']
        vol_r2 = vol.get('R2', 0)
        vol_mae = vol.get('MAE', 0)
        vol_acc = vol.get('Direction_Accuracy', 0)
        print(f"\n   ğŸ’§ VOLUME:")
        print(f"   RÂ²: {vol_r2:8.4f}")
        print(f"   MAE: {vol_mae:8.6f}")
        print(f"   Accuracy: {vol_acc:6.2f}%")
    
    # Evaluation
    print("\n   ğŸ“Š EVALUATION:")
    if price_r2_list:
        avg_r2 = sum(price_r2_list) / len(price_r2_list)
        
        if avg_r2 < 0:
            print("   âš ï¸  Negative RÂ² - model not converging")
            print("   ğŸ’¡ Suggestions:")
            print("      - Increase training epochs")
            print("      - Adjust teacher forcing ratio")
            print("      - Check feature engineering")
        elif avg_r2 < 0.2:
            print("   âš ï¸  Low RÂ² - limited performance")
        elif avg_r2 < 0.4:
            print("   âœ… Acceptable RÂ² - functional model")
        elif avg_r2 < 0.6:
            print("   âœ… Good RÂ² - solid performance")
        else:
            print("   ğŸ‰ Excellent RÂ² - high performance")
        
        avg_acc = sum(price_acc_list) / len(price_acc_list)
        if avg_acc > 55:
            print(f"   âœ… Good directional accuracy ({avg_acc:.1f}%)")
        elif avg_acc > 52:
            print(f"   âš ï¸  Modest accuracy ({avg_acc:.1f}%)")
        else:
            print(f"   âš ï¸  Low accuracy ({avg_acc:.1f}%)")
    
    # Architecture info
    print("\n   ğŸ—ï¸  ARCHITECTURE:")
    print(f"      Encoder: {config.get('encoder_layers', 3)}L Ã— {config.get('encoder_hidden', 128)}h")
    print(f"      Decoder: {config.get('decoder_layers', 2)}L Ã— {config.get('decoder_hidden', 128)}h")
    print(f"      SEQ_LEN: {config.get('seq_len', 90)}")

except FileNotFoundError:
    print("   âŒ Config file not found")
except Exception as e:
    print(f"   âŒ Error: {e}")
    import traceback
    traceback.print_exc()
PYEOF
      
      - name: ğŸ’¾ Commit model
        if: steps.check.outputs.should_train == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add Encoder-Decoder files
          git add ADAUSD_MODELS/encoder_decoder_lstm.pth 2>/dev/null || true
          git add ADAUSD_MODELS/config_encoder_decoder.json 2>/dev/null || true
          git add ADAUSD_MODELS/scaler_input_encdec.pkl 2>/dev/null || true
          git add ADAUSD_MODELS/scaler_output_price_encdec.pkl 2>/dev/null || true
          git add ADAUSD_MODELS/scaler_output_volume_encdec.pkl 2>/dev/null || true
          git add encoder_decoder_results.png 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            echo "ğŸ“‹ Files to commit:"
            git diff --staged --name-only
            
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸ¯ Encoder-Decoder LSTM trained: $TIMESTAMP"
            
            # Push with retry
            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              if git push; then
                echo ""
                echo "âœ… Encoder-Decoder model saved to repository"
                break
              else
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "âš ï¸ Retrying push ($i/$MAX_RETRIES)..."
                  sleep 2
                  git pull --rebase
                else
                  echo "âŒ Failed to push after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi
      
      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "${{ steps.check.outputs.should_train }}" = "true" ]; then
            echo "  âœ… ENCODER-DECODER LSTM TRAINED"
            echo ""
            echo "ğŸ“ Generated files:"
            
            if [ -f "ADAUSD_MODELS/encoder_decoder_lstm.pth" ]; then
              echo "   âœ… encoder_decoder_lstm.pth"
            else
              echo "   âŒ encoder_decoder_lstm.pth"
            fi
            
            if [ -f "ADAUSD_MODELS/config_encoder_decoder.json" ]; then
              echo "   âœ… config_encoder_decoder.json"
              CONFIG_FILE="ADAUSD_MODELS/config_encoder_decoder.json"
            else
              CONFIG_FILE=""
            fi
            
            if [ -f "encoder_decoder_results.png" ]; then
              echo "   âœ… encoder_decoder_results.png"
            fi
            
            # Show metrics summary
            if [ -n "$CONFIG_FILE" ]; then
              echo ""
              echo "ğŸ“Š Metrics summary:"
              python3 <<'PYEOF'
import json
try:
    with open('ADAUSD_MODELS/config_encoder_decoder.json', 'r') as f:
        config = json.load(f)
    
    metrics = config.get('metrics_test', {})
    if metrics:
        price = ['delta_open', 'delta_high', 'delta_low', 'delta_close']
        print("   ğŸ¯ PRICE:")
        for t in price:
            if t in metrics:
                r2 = metrics[t].get('R2', 0)
                acc = metrics[t].get('Direction_Accuracy', 0)
                print(f"      {t:14} RÂ²: {r2:6.4f}  Acc: {acc:5.2f}%")
        
        price_r2 = [metrics[t]['R2'] for t in price if t in metrics]
        if price_r2:
            print(f"\n   ğŸ“ˆ Avg Price RÂ²: {sum(price_r2)/len(price_r2):.4f}")
        
        if 'delta_volume' in metrics:
            vol_r2 = metrics['delta_volume'].get('R2', 0)
            vol_acc = metrics['delta_volume'].get('Direction_Accuracy', 0)
            print(f"\n   ğŸ’§ Volume: RÂ²: {vol_r2:6.4f}  Acc: {vol_acc:5.2f}%")
        
        if 'training_time_minutes' in config:
            print(f"\n   â±ï¸  Time: {config['training_time_minutes']:.1f} min")
        
        if 'total_epochs' in config:
            print(f"   ğŸ”„ Epochs: {config['total_epochs']}")
except:
    pass
PYEOF
            fi
          else
            echo "  â„¹ï¸ TRAINING NOT NEEDED"
            if [ -f "ADAUSD_MODELS/encoder_decoder_lstm.pth" ]; then
              last_train=$(stat -c %Y "ADAUSD_MODELS/encoder_decoder_lstm.pth")
              current_time=$(date +%s)
              age=$((current_time - last_train))
              days=$((age / 86400))
              echo "  Current model is $days days old"
            fi
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
