name: ðŸŒ Dashboard Sync

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  push:
    paths:
      - '*.csv'
      - '*.json'
      - '*.png'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout trading repo
        uses: actions/checkout@v4
        with:
          path: trading
      
      - name: ðŸ“¥ Checkout dashboard repo
        uses: actions/checkout@v4
        with:
          repository: winningtrendingbots/winningtrendingbots.github.io
          token: ${{ secrets.DASHBOARD_TOKEN }}
          path: dashboard
      
      - name: ðŸ“‚ Verificar archivos disponibles
        run: |
          echo "=== Archivos en trading repo ==="
          ls -la trading/*.csv trading/*.json trading/*.png 2>/dev/null || echo "No hay archivos CSV/JSON/PNG aÃºn"
          echo ""
          echo "Estos archivos se copiarÃ¡n a la RAÃZ de github.io"
      
      - name: ðŸ“‹ Copiar archivos a la RAÃZ
        run: |
          # Copiar CSVs a la raÃ­z (no a /data/)
          if ls trading/*.csv 1> /dev/null 2>&1; then
            cp trading/*.csv dashboard/
            echo "âœ… CSVs copiados a la raÃ­z"
          else
            echo "âš ï¸ No hay archivos CSV para copiar"
          fi
          
          # Copiar JSONs a la raÃ­z
          if ls trading/*.json 1> /dev/null 2>&1; then
            cp trading/*.json dashboard/
            echo "âœ… JSONs copiados a la raÃ­z"
          else
            echo "âš ï¸ No hay archivos JSON para copiar"
          fi
          
          # Copiar PNGs a la raÃ­z
          if ls trading/*.png 1> /dev/null 2>&1; then
            cp trading/*.png dashboard/
            echo "âœ… PNGs copiados a la raÃ­z"
          else
            echo "âš ï¸ No hay archivos PNG para copiar"
          fi
      
      - name: ðŸ“Š Crear metadata en la raÃ­z
        run: |
          cd dashboard
          echo "{
            \"last_sync\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"source_repo\": \"winningtrendingbots/Kraken-Trading\",
            \"sync_type\": \"automated\"
          }" > sync_metadata.json
      
      - name: ðŸš€ Commit y push
        run: |
          cd dashboard
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "ðŸ“­ No hay cambios para commitear"
          else
            git commit -m "ðŸ”„ Sync data $(date -u +%Y-%m-%d\ %H:%M:%S) UTC"
            git push
            echo "âœ… Cambios pusheados exitosamente"
          fi
