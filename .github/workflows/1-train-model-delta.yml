name: ğŸ¤– Train Hybrid Model

on:
  schedule:
    - cron: '0 2 * * *'  # Diario a las 2 AM UTC
  workflow_dispatch:
    inputs:
      force_train:
        description: 'Forzar reentrenamiento'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  train-hybrid:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Check model age
        id: check
        run: |
          echo "Verificando edad del modelo..."
          
          if [ "${{ github.event.inputs.force_train }}" = "true" ]; then
            echo "ğŸ”§ Entrenamiento forzado"
            echo "should_train=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -d "ADAUSD_MODELS" ] && [ -f "ADAUSD_MODELS/adausd_hybrid_lstm.pth" ]; then
            last_train=$(stat -c %Y "ADAUSD_MODELS/adausd_hybrid_lstm.pth")
            current_time=$(date +%s)
            age=$((current_time - last_train))
            days=$((age / 86400))
            
            echo "ğŸ“Š Modelo tiene $days dÃ­as"
            
            if [ $days -ge 7 ]; then
              echo "ğŸ”„ Reentrenamiento necesario (â‰¥7 dÃ­as)"
              echo "should_train=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Modelo vigente ($days dÃ­as)"
              echo "should_train=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ No existe modelo hÃ­brido"
            echo "should_train=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ Setup Python
        if: steps.check.outputs.should_train == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.check.outputs.should_train == 'true'
        run: |
          echo "ğŸ“¦ Instalando dependencias..."
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§  Train Hybrid LSTM Model
        if: steps.check.outputs.should_train == 'true'
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "ğŸ”¥ ============================================"
          echo "   ENTRENANDO MODELO LSTM HÃBRIDO OPTIMIZADO"
          echo "============================================"
          echo ""
          echo "âœ¨ Mejoras aplicadas:"
          echo "   â€¢ SEQ_LEN: 60 (mÃ¡s contexto)"
          echo "   â€¢ Hidden: 64 (menos overfitting)"
          echo "   â€¢ Dropout: 0.4 (mÃ¡s regularizaciÃ³n)"
          echo "   â€¢ Batch: 128 (mÃ¡s estable)"
          echo "   â€¢ LR: 0.0005 (convergencia suave)"
          echo "   â€¢ Early stopping mejorado"
          echo ""
          
          python adausd_lstm_5min_delta.py
          
          echo ""
          echo "âœ… Entrenamiento completado"
      
      - name: ğŸ“Š Validate metrics
        if: steps.check.outputs.should_train == 'true'
        run: |
          echo ""
          echo "ğŸ” Validando mÃ©tricas del modelo..."
          
          if [ -f "ADAUSD_MODELS/config_hybrid.json" ]; then
            echo "âœ… ConfiguraciÃ³n encontrada"
            
            echo ""
            echo "ğŸ“Š MÃ‰TRICAS DEL MODELO:"
            python3 << 'PYEOF'
import json
try:
    with open('ADAUSD_MODELS/config_hybrid.json', 'r') as f:
        config = json.load(f)
    
    metrics = config.get('metrics_test', {})
    
    if metrics:
        print("   Target          RÂ²        MAE")
        print("   ---------------------------------")
        
        for target, data in metrics.items():
            r2 = data.get('R2', 0)
            mae = data.get('MAE', 0)
            print(f"   {target:12} {r2:8.4f}   {mae:8.6f}")
        
        # ValidaciÃ³n de calidad
        avg_r2 = sum(m['R2'] for m in metrics.values()) / len(metrics)
        print(f"\n   ğŸ“ˆ RÂ² promedio: {avg_r2:.4f}")
        
        if avg_r2 < 0:
            print("   âš ï¸  RÂ² negativo - modelo no converge")
        elif avg_r2 < 0.3:
            print("   âš ï¸  RÂ² bajo - considerar ajustar hiperparÃ¡metros")
        elif avg_r2 < 0.5:
            print("   âœ… RÂ² aceptable")
        else:
            print("   ğŸ‰ RÂ² excelente")
except Exception as e:
    print(f"   Error: {e}")
PYEOF
          else
            echo "âŒ No se encontrÃ³ config_hybrid.json"
          fi
      
      - name: ğŸ’¾ Commit trained model
        if: steps.check.outputs.should_train == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # AÃ±adir archivos del modelo
          git add ADAUSD_MODELS/adausd_hybrid_lstm.pth 2>/dev/null || true
          git add ADAUSD_MODELS/config_hybrid.json 2>/dev/null || true
          git add ADAUSD_MODELS/scaler_input_hybrid.pkl 2>/dev/null || true
          git add ADAUSD_MODELS/scaler_output_hybrid.pkl 2>/dev/null || true
          git add adausd_hybrid_results.png 2>/dev/null || true
          git add ADAUSD_1h_data.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No hay cambios para commitear"
          else
            echo "ğŸ“‹ Archivos a commitear:"
            git diff --staged --name-only
            
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸ¤– Hybrid Model trained (optimized): $TIMESTAMP"
            
            # Push con retry
            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              if git push; then
                echo ""
                echo "âœ… Modelo guardado en repositorio"
                break
              else
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "âš ï¸ Reintentando push ($i/$MAX_RETRIES)..."
                  sleep 2
                  git pull --rebase
                else
                  echo "âŒ Error al guardar modelo despuÃ©s de $MAX_RETRIES intentos"
                  exit 1
                fi
              fi
            done
          fi
      
      - name: ğŸ“Š Training summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "${{ steps.check.outputs.should_train }}" = "true" ]; then
            echo "  âœ… MODELO HÃBRIDO OPTIMIZADO ENTRENADO"
            echo ""
            echo "ğŸ“ Archivos generados:"
            [ -f "ADAUSD_MODELS/adausd_hybrid_lstm.pth" ] && echo "   âœ… adausd_hybrid_lstm.pth" || echo "   âŒ adausd_hybrid_lstm.pth"
            [ -f "ADAUSD_MODELS/config_hybrid.json" ] && echo "   âœ… config_hybrid.json" || echo "   âŒ config_hybrid.json"
            [ -f "adausd_hybrid_results.png" ] && echo "   âœ… adausd_hybrid_results.png" || echo "   âš ï¸ adausd_hybrid_results.png"
            
            # Mostrar mÃ©tricas finales
            if [ -f "ADAUSD_MODELS/config_hybrid.json" ]; then
              echo ""
              echo "ğŸ“Š Resumen de mÃ©tricas:"
              python3 << 'PYEOF'
import json
try:
    with open('ADAUSD_MODELS/config_hybrid.json', 'r') as f:
        config = json.load(f)
    
    metrics = config.get('metrics_test', {})
    if metrics:
        print("   delta_high  RÂ²:", f"{metrics.get('delta_high', {}).get('R2', 0):.4f}")
        print("   delta_low   RÂ²:", f"{metrics.get('delta_low', {}).get('R2', 0):.4f}")
        print("   delta_close RÂ²:", f"{metrics.get('delta_close', {}).get('R2', 0):.4f}")
        
        avg_r2 = sum(m.get('R2', 0) for m in metrics.values()) / len(metrics)
        print(f"\n   ğŸ“ˆ RÂ² promedio: {avg_r2:.4f}")
        
        if 'training_time_minutes' in config:
            print(f"   â±ï¸  Tiempo: {config['training_time_minutes']:.1f} min")
        
        if 'total_epochs' in config:
            print(f"   ğŸ”„ Ã‰pocas: {config['total_epochs']}")
except:
    pass
PYEOF
            fi
          else
            echo "  â„¹ï¸ ENTRENAMIENTO NO NECESARIO"
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
