name: üî¨ Test Baseline Comparison

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ‚úÖ Verify files exist
        run: |
          echo "Verificando archivos necesarios..."
          
          if [ ! -f "ADAUSD_1h_data.csv" ]; then
            echo "ERROR: ADAUSD_1h_data.csv no existe"
            exit 1
          fi
          
          if [ ! -d "ADAUSD_MODELS" ]; then
            echo "ERROR: ADAUSD_MODELS no existe"
            exit 1
          fi
          
          if [ ! -f "ADAUSD_MODELS/adausd_lstm_1h.pth" ]; then
            echo "ERROR: Modelo no existe"
            exit 1
          fi
          
          echo "Todos los archivos presentes"
      
      - name: üî¨ Run baseline comparison
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "Ejecutando prueba de baseline..."
          python baseline_comparison.py
      
      - name: üìä Show results
        run: |
          echo ""
          echo "======================================================================"
          echo "  RESULTADOS DE LA COMPARACION"
          echo "======================================================================"
          echo ""
          
          if [ -f "baseline_comparison.json" ]; then
            cat baseline_comparison.json
          else
            echo "No se genero baseline_comparison.json"
          fi
      
      - name: üì§ Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: baseline-comparison-${{ github.run_number }}
          path: baseline_comparison.json
          retention-days: 30
      
      - name: üì± Send results to Telegram
        if: always()
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          if [ ! -f "baseline_comparison.json" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_API}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="Error: No se pudo generar comparacion de baseline"
            exit 0
          fi
          
          # Extraer metricas usando Python (mas confiable)
          python3 << 'PYEOF'
          import json
          import os
          import requests
          
          with open('baseline_comparison.json', 'r') as f:
              data = json.load(f)
          
          lstm_r2 = data['lstm']['r2']
          naive_r2 = data['naive']['r2']
          lstm_dir = data['lstm']['direction_accuracy']
          naive_dir = data['naive']['direction_accuracy']
          r2_improve = data['improvement_over_naive']['r2']
          dir_improve = data['improvement_over_naive']['direction']
          
          # Determinar veredicto
          if r2_improve < 0.01 and dir_improve < 5:
              verdict = "MODELO NO ES UTIL"
              emoji = "‚ùå"
              recommendation = "Cambiar a prediccion 6h+ adelante"
          elif r2_improve < 0.03 and dir_improve < 10:
              verdict = "MARGINALMENTE UTIL"
              emoji = "üü°"
              recommendation = "Optimizar para direccion no MAE"
          else:
              verdict = "MODELO UTIL"
              emoji = "‚úÖ"
              recommendation = "Proceder a paper trading"
          
          # Construir mensaje
          msg = f"""üî¨ Comparacion LSTM vs Baseline

#{emoji} {verdict}

üìä R2 Scores:
   LSTM: {lstm_r2:.4f}
   Naive: {naive_r2:.4f}
   Mejora: +{r2_improve:.4f}

üéØ Precision Direccional:
   LSTM: {lstm_dir:.1f}%
   Naive: {naive_dir:.1f}%
   Mejora: +{dir_improve:.1f}%

üí° Recomendacion:
{recommendation}

üìÅ Ver detalles en Actions"""
          
          # Enviar a Telegram
          telegram_api = os.environ.get('TELEGRAM_API')
          chat_id = os.environ.get('CHAT_ID')
          
          if telegram_api and chat_id:
              url = f"https://api.telegram.org/bot{telegram_api}/sendMessage"
              requests.post(url, data={'chat_id': chat_id, 'text': msg}, timeout=10)
              print("Mensaje enviado a Telegram")
          else:
              print("Telegram no configurado")
              print(msg)
          PYEOF
