name: üî¨ Test Baseline Comparison

on:
  workflow_dispatch:  # Ejecuci√≥n manual

permissions:
  contents: read

jobs:
  test-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ‚úÖ Verify files exist
        run: |
          echo "üîç Verificando archivos necesarios..."
          
          if [ ! -f "ADAUSD_1h_data.csv" ]; then
            echo "‚ùå ERROR: ADAUSD_1h_data.csv no existe"
            exit 1
          fi
          
          if [ ! -d "ADAUSD_MODELS" ]; then
            echo "‚ùå ERROR: ADAUSD_MODELS/ no existe"
            exit 1
          fi
          
          if [ ! -f "ADAUSD_MODELS/adausd_lstm_1h.pth" ]; then
            echo "‚ùå ERROR: Modelo no existe"
            exit 1
          fi
          
          echo "‚úÖ Todos los archivos cr√≠ticos presentes"
      
      - name: üî¨ Run baseline comparison
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "üî¨ Ejecutando prueba de baseline..."
          python baseline_comparison.py
      
      - name: üìä Show results
        run: |
          echo ""
          echo "======================================================================"
          echo "  üìä RESULTADOS DE LA COMPARACI√ìN"
          echo "======================================================================"
          echo ""
          
          if [ -f "baseline_comparison.json" ]; then
            cat baseline_comparison.json
          else
            echo "‚ö†Ô∏è No se gener√≥ baseline_comparison.json"
          fi
      
      - name: üì§ Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: baseline-comparison-${{ github.run_number }}
          path: |
            baseline_comparison.json
          retention-days: 30
      
      - name: üì± Send results to Telegram
        if: always()
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          if [ -f "baseline_comparison.json" ]; then
            # Extraer m√©tricas clave
            LSTM_R2=$(cat baseline_comparison.json | grep -A 5 '"lstm"' | grep '"r2"' | cut -d':' -f2 | cut -d',' -f1 | xargs)
            NAIVE_R2=$(cat baseline_comparison.json | grep -A 5 '"naive"' | grep '"r2"' | cut -d':' -f2 | cut -d',' -f1 | xargs)
            
            LSTM_DIR=$(cat baseline_comparison.json | grep -A 6 '"lstm"' | grep '"direction_accuracy"' | cut -d':' -f2 | cut -d',' -f1 | xargs)
            NAIVE_DIR=$(cat baseline_comparison.json | grep -A 6 '"naive"' | grep '"direction_accuracy"' | cut -d':' -f2 | cut -d',' -f1 | xargs)
            
            R2_IMPROVE=$(cat baseline_comparison.json | grep -A 2 '"improvement_over_naive"' | grep '"r2"' | cut -d':' -f2 | cut -d',' -f1 | xargs)
            DIR_IMPROVE=$(cat baseline_comparison.json | grep -A 2 '"improvement_over_naive"' | grep '"direction"' | cut -d':' -f2 | cut -d'}' -f1 | xargs)
            
            # Determinar veredicto
            if [ $(echo "$R2_IMPROVE < 0.01" | bc -l) -eq 1 ] && [ $(echo "$DIR_IMPROVE < 5" | bc -l) -eq 1 ]; then
              VERDICT="MODELO NO ES UTIL"
              EMOJI="‚ùå"
              RECOMMENDATION="Cambiar a prediccion 6h+ adelante"
            elif [ $(echo "$R2_IMPROVE < 0.03" | bc -l) -eq 1 ] && [ $(echo "$DIR_IMPROVE < 10" | bc -l) -eq 1 ]; then
              VERDICT="MARGINALMENTE UTIL"
              EMOJI="üü°"
              RECOMMENDATION="Optimizar para direccion no MAE"
            else
              VERDICT="MODELO UTIL"
              EMOJI="‚úÖ"
              RECOMMENDATION="Proceder a paper trading"
            fi
            
            # Construir mensaje sin problemas de sintaxis
            MSG="üî¨ Comparacion LSTM vs Baseline

${EMOJI} ${VERDICT}

üìä R2 Scores:
   LSTM: ${LSTM_R2}
   Naive: ${NAIVE_R2}
   Mejora: +${R2_IMPROVE}

üéØ Precision Direccional:
   LSTM: ${LSTM_DIR}%
   Naive: ${NAIVE_DIR}%
   Mejora: +${DIR_IMPROVE}%

üí° Recomendacion:
${RECOMMENDATION}

üìÅ Ver detalles en Actions"
            
            # Enviar a Telegram
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_API}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="${MSG}" || echo "‚ö†Ô∏è Telegram fall√≥"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_API}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="‚ùå Error: No se pudo generar comparacion de baseline" || echo "‚ö†Ô∏è Telegram fall√≥"
          fi
