name: ðŸ¤– Trading Bot Core

on:
  schedule:
    - cron: '0 * * * *'  # Cada hora
  workflow_dispatch:
    inputs:
      force_train:
        description: 'Forzar reentrenamiento'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: trading-bot-${{ github.ref }}
  cancel-in-progress: false

jobs:
  determine-task:
    runs-on: ubuntu-latest
    outputs:
      should_train: ${{ steps.check.outputs.should_train }}
      should_trade: ${{ steps.check.outputs.should_trade }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ” Determinar tarea
        id: check
        run: |
          echo "ðŸ” Verificando estado del sistema..."
          
          # Verificar si existe el modelo
          if [ -d "ADAUSD_MODELS" ] && [ "$(ls -A ADAUSD_MODELS 2>/dev/null)" ]; then
            echo "âœ… Modelo existe"
            
            # Verificar antigÃ¼edad del modelo (reentrenar cada 7 dÃ­as)
            last_train=$(find ADAUSD_MODELS -type f -name "*.keras" -printf '%T@\n' | sort -n | tail -1)
            current_time=$(date +%s)
            age=$((current_time - ${last_train:-0}))
            days=$((age / 86400))
            
            echo "ðŸ“… Modelo tiene $days dÃ­as"
            
            if [ $days -gt 7 ] || [ "${{ github.event.inputs.force_train }}" = "true" ]; then
              echo "ðŸ”„ Reentrenamiento necesario"
              echo "should_train=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Modelo vigente"
              echo "should_train=false" >> $GITHUB_OUTPUT
            fi
            
            echo "should_trade=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No existe modelo, entrenar primero"
            echo "should_train=true" >> $GITHUB_OUTPUT
            echo "should_trade=false" >> $GITHUB_OUTPUT
          fi

  train-model:
    needs: determine-task
    if: needs.determine-task.outputs.should_train == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ§  Train model
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ðŸ§  Entrenando modelo LSTM..."
          python adausd_lstm.py
      
      - name: ðŸ’¾ Commit models
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add ADAUSD_MODELS/ ADAUSD_1h_data.csv *.png
          
          if git diff --staged --quiet; then
            echo "No hay cambios en modelos"
          else
            git commit -m "ðŸ§  Model trained $(date -u +%Y-%m-%d)"
            git push
          fi

  predict-and-trade:
    needs: [determine-task, train-model]
    if: |
      always() &&
      needs.determine-task.outputs.should_trade == 'true' &&
      (needs.train-model.result == 'success' || needs.train-model.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ”® Predict and trade
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ðŸ”® Generando predicciones y ejecutando trades..."
          python predict_and_filter.py
          python trading_orchestrator.py
      
      - name: ðŸ’¾ Save results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Agregar todos los CSVs y archivos generados
          git add -A *.csv *.json *.png 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No hay nuevos datos para commitear"
          else
            git commit -m "ðŸ“Š Trading cycle $(date -u +%Y-%m-%d\ %H:%M) UTC"
            git push
          fi

  monitor-orders:
    needs: predict-and-trade
    if: always() && needs.predict-and-trade.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ‘€ Monitor orders
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ðŸ‘€ Monitoreando Ã³rdenes abiertas..."
          python kraken_trader.py
      
      - name: ðŸ’¾ Update trades
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add kraken_trades.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No hay actualizaciones de trades"
          else
            git commit -m "ðŸ“ˆ Orders monitored $(date -u +%H:%M) UTC"
            git push
          fi
