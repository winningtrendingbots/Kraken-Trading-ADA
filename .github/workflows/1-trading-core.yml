name: ü§ñ Trading Bot Core

on:
  schedule:
    - cron: '0 8 * * *'        # üß† Train diario 08:00 UTC
    - cron: '*/11 * * * *'     # üîÆ Predict + Trade cada 11 min
    - cron: '*/4 * * * *'      # üëÅÔ∏è Monitor cada 4 min

  workflow_dispatch:
    inputs:
      task:
        description: 'Tarea a ejecutar'
        required: true
        type: choice
        options:
          - train
          - predict_trade
          - monitor
          - all

permissions:
  contents: write

concurrency:
  group: trading-${{ github.run_id }}
  cancel-in-progress: false

jobs:
# ==========================================================
# üß† DECIDIR QU√â SE EJECUTA (L√ìGICA MEJORADA)
# ==========================================================
  determine-task:
    runs-on: ubuntu-latest
    outputs:
      should_train: ${{ steps.decide.outputs.should_train }}
      should_predict_trade: ${{ steps.decide.outputs.should_predict_trade }}
      should_monitor: ${{ steps.decide.outputs.should_monitor }}

    steps:
      - name: Decide tasks
        id: decide
        run: |
          HOUR=$(date -u +%H)
          MIN=$(date -u +%M)

          TRAIN=false
          PREDICT_TRADE=false
          MONITOR=false

          echo "‚è∞ Hora actual: $HOUR:$MIN UTC"
          echo "üéØ Event: ${{ github.event_name }}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üìù Manual trigger detected"
            case "${{ github.event.inputs.task }}" in
              train)
                TRAIN=true
                ;;
              predict_trade)
                PREDICT_TRADE=true
                ;;
              monitor)
                MONITOR=true
                ;;
              all)
                TRAIN=true
                PREDICT_TRADE=true
                MONITOR=true
                ;;
            esac
          else
            # üß† Train diario ~08:00 UTC (tolerancia ¬±5 min)
            if [ "$HOUR" = "08" ] && [ "$MIN" -ge 0 ] && [ "$MIN" -le 10 ]; then
              echo "üß† Train time detected"
              TRAIN=true
            fi

            # üîÆ Predict + Trade: detectar por resto de divisi√≥n (m√°s tolerante)
            # En lugar de MIN % 11 == 0, usar rango ¬±2 minutos
            REMAINDER=$((MIN % 11))
            if [ "$REMAINDER" -le 2 ] || [ "$REMAINDER" -ge 9 ]; then
              echo "üîÆ Predict+Trade time detected (MIN=$MIN, remainder=$REMAINDER)"
              PREDICT_TRADE=true
            fi

            # üëÅÔ∏è Monitor: detectar por resto de divisi√≥n (m√°s tolerante)
            REMAINDER=$((MIN % 4))
            if [ "$REMAINDER" -le 1 ] || [ "$REMAINDER" -ge 3 ]; then
              echo "üëÅÔ∏è Monitor time detected (MIN=$MIN, remainder=$REMAINDER)"
              MONITOR=true
            fi
          fi

          echo "üìä Decisions:"
          echo "  - Train: $TRAIN"
          echo "  - Predict+Trade: $PREDICT_TRADE"
          echo "  - Monitor: $MONITOR"

          echo "should_train=$TRAIN" >> $GITHUB_OUTPUT
          echo "should_predict_trade=$PREDICT_TRADE" >> $GITHUB_OUTPUT
          echo "should_monitor=$MONITOR" >> $GITHUB_OUTPUT

# ==========================================================
# üß† TRAIN MODEL
# ==========================================================
  train-model:
    needs: determine-task
    if: needs.determine-task.outputs.should_train == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python adausd_lstm.py

      - name: Commit model
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "üß† Model trained $(date -u +'%Y-%m-%d %H:%M')" || echo "No changes"
          git push origin main

# ==========================================================
# üîÆ PREDICT + TRADE
# ==========================================================
  predict-and-trade:
    needs: determine-task
    if: needs.determine-task.outputs.should_predict_trade == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check open orders
        id: check_orders
        run: |
          COUNT=0
          if [ -f open_orders.json ]; then
            COUNT=$(grep -c '"txid"' open_orders.json || echo 0)
          fi

          echo "open_orders=$COUNT" >> $GITHUB_OUTPUT

          if [ "$COUNT" -gt 3 ]; then
            echo "‚ùå M√°s de 3 √≥rdenes abiertas ($COUNT), NO se tradea"
            exit 0
          fi

      - name: Predict
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python predict_and_filter.py

      - name: Trade
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: python kraken_trader.py

      - name: Commit trading data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add trading_signals.csv orders_executed.csv kraken_trades.csv open_orders.json prediction_tracker.csv || true
          git commit -m "üîÆ Trade $(date -u +'%H:%M')" || echo "No changes"
          git push origin main

# ==========================================================
# üëÅÔ∏è MONITOR
# ==========================================================
  monitor-orders:
    needs: determine-task
    if: needs.determine-task.outputs.should_monitor == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Monitor orders
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          if [ ! -f open_orders.json ]; then 
            echo "No hay open_orders.json"
            exit 0
          fi
          python -c "from kraken_trader import monitor_orders; monitor_orders()"

      - name: Commit monitor updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add kraken_trades.csv open_orders.json prediction_tracker.csv || true
          git commit -m "üëÅÔ∏è Monitor $(date -u +'%H:%M')" || echo "No changes"
          git push origin main
