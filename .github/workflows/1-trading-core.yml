name: ü§ñ Trading Bot Core

on:
  schedule:
    - cron: '0 8 * * *'        # üß† Train diario 08:00 UTC
    - cron: '*/11 * * * *'     # üîÆ Predict + Trade cada 11 min
    - cron: '*/4 * * * *'      # üëÅÔ∏è Monitor cada 4 min
    - cron: '0 0 * * 0'        # üîÑ Keepalive semanal

  workflow_dispatch:
    inputs:
      task:
        description: 'Tarea a ejecutar'
        required: true
        type: choice
        options:
          - train
          - predict_trade
          - monitor
          - all
          - keepalive

permissions:
  contents: write

concurrency:
  group: trading-${{ github.run_id }}
  cancel-in-progress: false

jobs:
# ==========================================================
# üîÑ KEEPALIVE - Mantiene el repo activo
# ==========================================================
  keepalive:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 0'
    steps:
      - uses: actions/checkout@v4
      
      - name: Keepalive commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Crear/actualizar archivo keepalive
          echo "Last keepalive: $(date -u)" > .github/keepalive.txt
          git add .github/keepalive.txt
          git commit -m "üîÑ Keepalive $(date -u +'%Y-%m-%d')" || echo "No changes"
          git push origin main

# ==========================================================
# üß† DECIDIR QU√â SE EJECUTA
# ==========================================================
  determine-task:
    runs-on: ubuntu-latest
    if: github.event.schedule != '0 0 * * 0'
    outputs:
      should_train: ${{ steps.decide.outputs.should_train }}
      should_predict_trade: ${{ steps.decide.outputs.should_predict_trade }}
      should_monitor: ${{ steps.decide.outputs.should_monitor }}

    steps:
      - name: Decide tasks
        id: decide
        run: |
          HOUR=$(date -u +%H)
          MIN=$(date -u +%M)

          TRAIN=false
          PREDICT_TRADE=false
          MONITOR=false

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            case "${{ github.event.inputs.task }}" in
              train)
                TRAIN=true
                ;;
              predict_trade)
                PREDICT_TRADE=true
                ;;
              monitor)
                MONITOR=true
                ;;
              all)
                TRAIN=true
                PREDICT_TRADE=true
                MONITOR=true
                ;;
              keepalive)
                echo "Keepalive manual"
                exit 0
                ;;
            esac
          else
            # üß† Train diario 08:00 UTC
            if [ "$HOUR" = "08" ] && [ "$MIN" = "00" ]; then
              TRAIN=true
            fi

            # üîÆ Predict + Trade cada 11 minutos
            if (( MIN % 11 == 0 )); then
              PREDICT_TRADE=true
            fi

            # üëÅÔ∏è Monitor cada 4 minutos
            if (( MIN % 4 == 0 )); then
              MONITOR=true
            fi
          fi

          echo "should_train=$TRAIN" >> $GITHUB_OUTPUT
          echo "should_predict_trade=$PREDICT_TRADE" >> $GITHUB_OUTPUT
          echo "should_monitor=$MONITOR" >> $GITHUB_OUTPUT

# ==========================================================
# üß† TRAIN MODEL
# ==========================================================
  train-model:
    needs: determine-task
    if: needs.determine-task.outputs.should_train == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python adausd_lstm.py

      - name: Commit model
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "üß† Model trained $(date -u +'%Y-%m-%d %H:%M')" || echo "No changes"
          git push origin main

# ==========================================================
# üîÆ PREDICT + TRADE
# ==========================================================
  predict-and-trade:
    needs: determine-task
    if: needs.determine-task.outputs.should_predict_trade == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check open orders
        id: check_orders
        run: |
          COUNT=0
          if [ -f open_orders.json ]; then
            COUNT=$(grep -c '"txid"' open_orders.json || echo 0)
          fi

          echo "open_orders=$COUNT" >> $GITHUB_OUTPUT

          if [ "$COUNT" -gt 3 ]; then
            echo "‚ùå M√°s de 3 √≥rdenes abiertas, NO se tradea"
            exit 0
          fi

      - name: Predict
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python predict_and_filter.py

      - name: Trade
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: python kraken_trader.py

      - name: Commit trading data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add trading_signals.csv orders_executed.csv kraken_trades.csv open_orders.json prediction_tracker.csv || true
          git commit -m "üîÆ Predict & Trade $(date -u +'%H:%M')" || echo "No changes"
          git push origin main

# ==========================================================
# üëÅÔ∏è MONITOR
# ==========================================================
  monitor-orders:
    needs: determine-task
    if: needs.determine-task.outputs.should_monitor == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Monitor orders
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        run: |
          if [ ! -f open_orders.json ]; then exit 0; fi
          python -c "from kraken_trader import monitor_orders; monitor_orders()"

      - name: Commit monitor updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add kraken_trades.csv open_orders.json prediction_tracker.csv || true
          git commit -m "üëÅÔ∏è Monitor $(date -u +'%H:%M')" || echo "No changes"
          git push origin main
