name: ğŸ¤– Training - Sin Conflictos

on:
  schedule:
    - cron: '0 8 * * *'  # Diario a las 9 AM UTC
  workflow_dispatch:     # Manual

permissions:
  contents: write

concurrency:
  group: training
  cancel-in-progress: false  # No cancelar si ya estÃ¡ corriendo

jobs:
  train-model:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: ğŸ“¥ Checkout con estrategia segura
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§  Entrenar modelo
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ğŸ”§ Iniciando entrenamiento..."
          python adausd_lstm.py
      
      - name: âœ… Verificar archivos generados
        id: check_files
        run: |
          echo "ğŸ“‚ Verificando archivos generados..."
          
          files_ok=true
          
          if [ -d "ADAUSD_MODELS" ]; then
            echo "âœ… ADAUSD_MODELS/ generado"
            ls -lh ADAUSD_MODELS/
          else
            echo "âŒ ADAUSD_MODELS/ NO generado"
            files_ok=false
          fi
          
          if [ -f "ADAUSD_1h_data.csv" ]; then
            echo "âœ… ADAUSD_1h_data.csv generado"
          else
            echo "âŒ ADAUSD_1h_data.csv NO generado"
            files_ok=false
          fi
          
          if [ -f "adausd_results.png" ]; then
            echo "âœ… adausd_results.png generado"
          else
            echo "âš ï¸ adausd_results.png NO generado (no crÃ­tico)"
          fi
          
          echo "files_ok=$files_ok" >> $GITHUB_OUTPUT
      
      - name: ğŸ’¾ Guardar con manejo de conflictos
        if: steps.check_files.outputs.files_ok == 'true'
        run: |
          echo "ğŸ”§ Configurando Git..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ğŸ“¥ Sincronizando con remoto..."
          # Fetch primero para ver el estado
          git fetch origin main
          
          # Ver si hay divergencia
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse origin/main)
          
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "âš ï¸ Detectada divergencia con remoto"
            echo "   Local:  $LOCAL"
            echo "   Remote: $REMOTE"
            
            # Stash cambios actuales
            echo "ğŸ“¦ Guardando cambios temporalmente..."
            git stash --include-untracked
            
            # Pull del remoto
            echo "ğŸ“¥ Obteniendo cambios remotos..."
            git pull --rebase origin main || {
              echo "âŒ Error en pull, intentando reset..."
              git rebase --abort 2>/dev/null || true
              git reset --hard origin/main
            }
            
            # Aplicar nuestros cambios encima
            echo "ğŸ“¤ Aplicando nuestros cambios..."
            git stash pop || {
              echo "âš ï¸ Conflicto al aplicar stash, forzando nuestros cambios..."
              git checkout --theirs ADAUSD_MODELS/ ADAUSD_1h_data.csv adausd_results.png 2>/dev/null || true
              git stash drop
            }
          else
            echo "âœ… Repo sincronizado con remoto"
          fi
          
          echo ""
          echo "â• Agregando archivos..."
          
          # Agregar forzadamente los archivos del modelo
          git add -f ADAUSD_MODELS/ 2>/dev/null || echo "âš ï¸ ADAUSD_MODELS/ no aÃ±adido"
          git add -f ADAUSD_1h_data.csv 2>/dev/null || echo "âš ï¸ CSV no aÃ±adido"
          git add -f adausd_results.png 2>/dev/null || echo "âš ï¸ PNG no aÃ±adido"
          git add -f LAST_TRAINING.txt 2>/dev/null || true
          git add -f risk_config.json 2>/dev/null || true
          
          echo ""
          echo "ğŸ“‹ Estado de Git:"
          git status --short
          
          echo ""
          echo "ğŸ’¾ Commiteando..."
          
          # Siempre commitear, incluso si no hay cambios visibles
          if git diff --staged --quiet; then
            echo "âš ï¸ No hay cambios staged, creando commit con --allow-empty"
            git commit --allow-empty -m "ğŸ¤– Model trained [$(date +'%Y-%m-%d %H:%M UTC')]
            
            Training completed successfully
            - Model: ADAUSD Multi-Output LSTM
            - Timeframe: 1h
            - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            "
          else
            echo "âœ… Cambios detectados, commiteando..."
            
            # Contar archivos cambiados
            FILES_CHANGED=$(git diff --staged --name-only | wc -l)
            
            git commit -m "ğŸ¤– Model trained [$(date +'%Y-%m-%d %H:%M UTC')]
            
            Files updated: $FILES_CHANGED
            - Model: ADAUSD_MODELS/
            - Data: ADAUSD_1h_data.csv
            - Chart: adausd_results.png
            
            Training timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            "
          fi
          
          echo ""
          echo "ğŸ“¤ Pushing a remoto..."
          
          # Intentar push normal primero
          if git push origin main; then
            echo "âœ… Push exitoso (normal)"
          else
            echo "âš ï¸ Push normal fallÃ³, intentando con --force-with-lease..."
            
            # Force con protecciÃ³n (solo si nuestro commit es mÃ¡s reciente)
            if git push --force-with-lease origin main; then
              echo "âœ… Push exitoso (force-with-lease)"
            else
              echo "âŒ Push fallÃ³ incluso con force-with-lease"
              echo "ğŸ”„ Ãšltimo intento: pull + push..."
              
              git pull --rebase origin main || git rebase --abort
              
              # Intentar una vez mÃ¡s
              git push origin main || {
                echo "âŒ ERROR: No se pudo hacer push despuÃ©s de mÃºltiples intentos"
                echo "ğŸ“‹ Logs para debugging:"
                git log --oneline -5
                git remote -v
                exit 1
              }
            fi
          fi
          
          echo ""
          echo "âœ… Â¡Modelo guardado exitosamente!"
          
          # Mostrar Ãºltimos commits
          echo ""
          echo "ğŸ“œ Ãšltimos commits:"
          git log --oneline -3
      
      - name: ğŸ“± Notificar resultado
        if: always()
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          if [ "${{ steps.check_files.outputs.files_ok }}" == "true" ] && [ "${{ job.status }}" == "success" ]; then
            STATUS="âœ… Ã‰XITO"
            MSG="ğŸ¤– *Modelo Entrenado Exitosamente*

â° Tiempo: $(date +'%Y-%m-%d %H:%M UTC')
âœ… Modelo guardado en GitHub
ğŸ“Š Datos actualizados
ğŸ“ˆ GrÃ¡ficas generadas

ğŸ”— Ver resultados en el repo"
          else
            STATUS="âŒ ERROR"
            MSG="âŒ *Error en Entrenamiento*

â° Tiempo: $(date +'%Y-%m-%d %H:%M UTC')
ğŸ“‹ Revisa los logs en GitHub Actions

ğŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          echo "$MSG"
          
          # Enviar a Telegram
          if [ -n "$TELEGRAM_API" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_API}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${MSG}" \
              -d parse_mode="Markdown" || echo "âš ï¸ Telegram notification failed"
          fi
      
      - name: ğŸ“¦ Subir artefactos (backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-results-${{ github.run_number }}
          path: |
            ADAUSD_MODELS/
            ADAUSD_1h_data.csv
            adausd_results.png
            LAST_TRAINING.txt
          retention-days: 7
