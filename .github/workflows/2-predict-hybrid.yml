name: üîÆ Predict & Trade (Hybrid Model)

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  workflow_dispatch:
    inputs:
      use_legacy:
        description: 'Usar predictor legacy'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  predict-and-trade:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üìã Log execution
        run: |
          echo "üïê Workflow ejecutado: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üåø Branch: ${{ github.ref }}"
          echo "üéØ Modelo: ${{ github.event.inputs.use_legacy == 'true' && 'Legacy' || 'H√≠brido' }}"
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîç Check hybrid model
        id: check
        run: |
          echo "üîç Verificando modelo h√≠brido..."
          
          if [ -f "ADAUSD_MODELS/adausd_hybrid_lstm.pth" ]; then
            echo "‚úÖ Modelo h√≠brido encontrado"
            echo "has_model=true" >> $GITHUB_OUTPUT
            
            # Mostrar info
            if [ -f "ADAUSD_MODELS/config_hybrid.json" ]; then
              echo ""
              echo "üìä Informaci√≥n del modelo:"
              python3 << 'PYEOF'
              import json, os, datetime
              try:
                  with open('ADAUSD_MODELS/config_hybrid.json', 'r') as f:
                      config = json.load(f)
                  
                  # Informaci√≥n b√°sica
                  print(f"   Features: {config.get('input_size', 'N/A')}")
                  print(f"   Outputs: {config.get('output_size', 'N/A')}")
                  print(f"   Sequence: {config.get('seq_len', 'N/A')}")
                  print(f"   Hidden: {config.get('hidden_size', 'N/A')}")
                  print(f"   Bidirectional: {config.get('bidirectional', False)}")
                  
                  # M√©tricas
                  if 'metrics_test' in config:
                      metrics = config['metrics_test']
                      print(f"\n   üìà M√©tricas R¬≤:")
                      for target in ['delta_high', 'delta_low', 'delta_close']:
                          if target in metrics:
                              r2 = metrics[target].get('R2', 0)
                              print(f"      {target}: {r2:.4f}")
                      
                      avg_r2 = sum(m.get('R2', 0) for m in metrics.values()) / len(metrics)
                      print(f"\n   üéØ R¬≤ promedio: {avg_r2:.4f}")
                      
                      if avg_r2 < 0.3:
                          print("   ‚ö†Ô∏è  Calidad baja - considerar reentrenamiento")
                      elif avg_r2 < 0.5:
                          print("   ‚úÖ Calidad aceptable")
                      else:
                          print("   üéâ Calidad excelente")
                  
                  # Edad del modelo
                  if 'timestamp' in config:
                      import dateutil.parser
                      train_time = dateutil.parser.parse(config['timestamp'])
                      age = datetime.datetime.now(datetime.timezone.utc) - train_time.replace(tzinfo=datetime.timezone.utc)
                      print(f"\n   üïê Edad del modelo: {age.days} d√≠as")
                      
                      if age.days > 7:
                          print("   üîÑ Modelo desactualizado (>7 d√≠as)")
                  
              except Exception as e:
                  print(f"   Error: {e}")
              PYEOF
                          fi
                        else
                          echo "‚ùå No hay modelo h√≠brido entrenado"
                          echo "has_model=false" >> $GITHUB_OUTPUT
                        fi
      
      - name: ‚è≥ Wait for model training
        if: steps.check.outputs.has_model == 'false'
        run: |
          echo ""
          echo "‚è≥ ============================================"
          echo "   NO HAY MODELO H√çBRIDO ENTRENADO"
          echo "============================================"
          echo ""
          echo "üéØ Para empezar a predecir:"
          echo "   1. Ve a 'Actions' ‚Üí 'Train Hybrid Model'"
          echo "   2. Presiona 'Run workflow'"
          echo "   3. Espera ~20-30 minutos"
          echo ""
          echo "‚ú® Beneficios del modelo h√≠brido:"
          echo "   ‚úÖ LSTM bidireccional con atenci√≥n"
          echo "   ‚úÖ Derivadas de volumen avanzadas"
          echo "   ‚úÖ Detecci√≥n de divergencias"
          echo "   ‚úÖ Validaci√≥n de breakouts"
          echo "   ‚úÖ Predicciones ancladas al precio"
          echo ""
          exit 0
      
      - name: üêç Setup Python
        if: steps.check.outputs.has_model == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        if: steps.check.outputs.has_model == 'true'
        run: |
          echo "üì¶ Instalando dependencias..."
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üîÆ Generate predictions (Hybrid Model)
        if: steps.check.outputs.has_model == 'true' && github.event.inputs.use_legacy != 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üîÆ ============================================"
          echo "   GENERANDO PREDICCIONES (MODELO H√çBRIDO)"
          echo "============================================"
          echo ""
          echo "‚ú® Caracter√≠sticas activas:"
          echo "   ‚Ä¢ LSTM bidireccional con atenci√≥n"
          echo "   ‚Ä¢ Derivadas 1ra y 2da de volumen"
          echo "   ‚Ä¢ Indicadores OBV, VWAP, PVT"
          echo "   ‚Ä¢ Detecci√≥n de divergencias"
          echo "   ‚Ä¢ Validaci√≥n de breakouts"
          echo ""
          
          if python predict_delta_5min.py; then
            echo ""
            echo "‚úÖ Predicci√≥n completada (Modelo H√≠brido)"
            
            if [ -f "trading_signals.csv" ]; then
              lines=$(wc -l < trading_signals.csv)
              echo "‚úÖ Se√±ales guardadas: $lines"
              
              echo ""
              echo "üìä √öltima se√±al generada:"
              tail -n 1 trading_signals.csv
            else
              echo "‚ö†Ô∏è No se generaron se√±ales de trading"
            fi
          else
            echo ""
            echo "‚ùå Error en predict_delta_5min.py"
            exit 1
          fi
      
      - name: üíº Execute trades
        if: steps.check.outputs.has_model == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üíº ============================================"
          echo "   EJECUTANDO ESTRATEGIA DE TRADING"
          echo "============================================"
          echo ""
          
          if python trading_orchestrator.py; then
            echo ""
            echo "‚úÖ Trading ejecutado"
          else
            echo ""
            echo "‚ö†Ô∏è Error en trading_orchestrator.py (no cr√≠tico)"
          fi
      
      - name: üíæ Save results
        if: steps.check.outputs.has_model == 'true'
        run: |
          echo ""
          echo "üíæ ============================================"
          echo "   GUARDANDO RESULTADOS"
          echo "============================================"
          echo ""
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Archivos a guardar
          files=0
          for file in trading_signals.csv prediction_tracker.csv orders_executed.csv open_orders.json kraken_trades.csv; do
            if [ -f "$file" ] && [ -s "$file" ]; then
              git add "$file" 2>/dev/null
              files=$((files + 1))
            fi
          done
          
          if [ $files -eq 0 ]; then
            echo "‚ÑπÔ∏è No hay datos nuevos que guardar"
          else
            echo "üìã Archivos modificados ($files):"
            git status --porcelain | grep -E "\.(csv|json)$" || true
            
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ü§ñ Trading cycle [Hybrid]: $TIMESTAMP"
            
            for i in {1..3}; do
              if git push; then
                echo "‚úÖ Datos guardados correctamente"
                break
              elif [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Reintentando push ($i/3)..."
                sleep 2
                git pull --rebase
              else
                echo "‚ùå Error al guardar datos"
                exit 1
              fi
            done
          fi
      
      - name: üìä Execution summary
        if: always() && steps.check.outputs.has_model == 'true'
        run: |
          echo ""
          echo "üìä ============================================"
          echo "   RESUMEN DE EJECUCI√ìN"
          echo "============================================"
          echo ""
          
          echo "üéØ Modelo: ${{ github.event.inputs.use_legacy == 'true' && 'Legacy' || 'H√≠brido' }}"
          echo ""
          
          echo "üìÅ Archivos de datos:"
          [ -f "trading_signals.csv" ] && lines=$(wc -l < trading_signals.csv) && echo "  ‚úÖ trading_signals.csv ($lines)" || echo "  ‚ùå trading_signals.csv"
          [ -f "prediction_tracker.csv" ] && lines=$(wc -l < prediction_tracker.csv) && echo "  ‚úÖ prediction_tracker.csv ($lines)" || echo "  ‚ùå prediction_tracker.csv"
          [ -f "orders_executed.csv" ] && lines=$(wc -l < orders_executed.csv) && echo "  ‚úÖ orders_executed.csv ($((lines-1)))" || echo "  ‚ö†Ô∏è orders_executed.csv"
          [ -f "open_orders.json" ] && echo "  ‚úÖ open_orders.json" || echo "  ‚ö†Ô∏è open_orders.json"
          [ -f "kraken_trades.csv" ] && lines=$(wc -l < kraken_trades.csv) && echo "  ‚úÖ kraken_trades.csv ($((lines-1)))" || echo "  ‚ö†Ô∏è kraken_trades.csv"
          
          echo ""
          
          if [ -f "prediction_tracker.csv" ]; then
            echo "üìà Estad√≠sticas recientes:"
            python3 << 'PYEOF'
            import pandas as pd
            try:
                df = pd.read_csv('prediction_tracker.csv')
                if len(df) > 0:
                    recent = df.tail(20)
                    
                    buy_signals = (recent['signal'] == 'BUY').sum()
                    sell_signals = (recent['signal'] == 'SELL').sum()
                    hold_signals = (recent['signal'] == 'HOLD').sum()
                    
                    avg_confidence = recent['confidence'].mean()
                    avg_delta = recent['delta_close_%'].mean()
                    
                    print(f"  √öltimas 20 predicciones:")
                    print(f"    BUY: {buy_signals}, SELL: {sell_signals}, HOLD: {hold_signals}")
                    print(f"    Confianza promedio: {avg_confidence:.1f}%")
                    print(f"    Delta promedio: {avg_delta:+.3f}%")
                    
                    # Tasa de se√±ales v√°lidas
                    valid_signals = buy_signals + sell_signals
                    if valid_signals > 0:
                        signal_rate = valid_signals / 20 * 100
                        print(f"    Tasa de se√±ales: {signal_rate:.1f}%")
            except Exception as e:
                print(f"  Error: {e}")
            PYEOF
                      fi
          
          echo ""
          echo "üïê Pr√≥xima ejecuci√≥n: En 5 minutos"
          echo "üéØ Modelo h√≠brido activo"
          echo ""
