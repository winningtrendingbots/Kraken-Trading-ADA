name: üîÑ Sync Data to Dashboard

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos (m√°s frecuente que predict)
  push:
    branches: [ main ]
    paths:
      - '*.csv'
      - '*.json'
      - '*.png'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: Set up job
        run: echo "üöÄ Iniciando sincronizaci√≥n..."
      
      - name: Checkout trading repo
        uses: actions/checkout@v4
        with:
          path: trading
      
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
        with:
          repository: winningtrendingbots/winningtrendingbots.github.io
          token: ${{ secrets.DASHBOARD_TOKEN }}
          path: dashboard
      
      - name: Copy CSV files
        run: |
          echo "üìã Copiando archivos CSV..."
          
          # Funci√≥n para copiar si existe
          copy_if_exists() {
            if [ -f "trading/$1" ]; then
              cp "trading/$1" "dashboard/$1"
              echo "‚úÖ Copiado: $1"
              return 0
            else
              echo "‚ö†Ô∏è No existe a√∫n: $1"
              return 1
            fi
          }
          
          # Intentar copiar cada archivo
          files_copied=0
          
          if copy_if_exists "kraken_trades.csv"; then files_copied=$((files_copied + 1)); fi
          if copy_if_exists "trading_signals.csv"; then files_copied=$((files_copied + 1)); fi
          if copy_if_exists "orders_executed.csv"; then files_copied=$((files_copied + 1)); fi
          if copy_if_exists "ADAUSD_1h_data.csv"; then files_copied=$((files_copied + 1)); fi
          
          # Copiar cualquier otro CSV
          for file in trading/*.csv; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if ! [ -f "dashboard/$filename" ]; then
                cp "$file" "dashboard/$filename"
                echo "‚úÖ Copiado adicional: $filename"
                files_copied=$((files_copied + 1))
              fi
            fi
          done
          
          # Copiar JSONs si existen
          for file in trading/*.json; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              cp "$file" "dashboard/$filename"
              echo "‚úÖ Copiado JSON: $filename"
              files_copied=$((files_copied + 1))
            fi
          done
          
          # Copiar PNGs si existen
          for file in trading/*.png; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              cp "$file" "dashboard/$filename"
              echo "‚úÖ Copiado PNG: $filename"
              files_copied=$((files_copied + 1))
            fi
          done
          
          echo ""
          echo "üìä Total de archivos copiados: $files_copied"
          
          # Si no hay archivos, crear placeholders
          if [ $files_copied -eq 0 ]; then
            echo "‚ö†Ô∏è No hay datos a√∫n. Creando placeholders..."
            
            echo "timestamp,txid,side,entry_price,close_price,volume,tp,sl,close_reason,time_open_min,pnl_usd,pnl_%" > dashboard/kraken_trades.csv
            echo "timestamp,current_price,pred_high,pred_low,pred_close,pred_change_%,atr,volatility,trend,signal,confidence" > dashboard/trading_signals.csv
            
            echo "‚úÖ Placeholders creados"
          fi
      
      - name: Create data directory if not exists
        run: mkdir -p dashboard/data
      
      - name: Create metadata
        run: |
          cd dashboard
          
          # Contar archivos reales (no vac√≠os)
          csv_count=$(find . -maxdepth 1 -name "*.csv" -type f -size +100c | wc -l)
          
          cat > sync_metadata.json << EOF
          {
            "last_sync": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source_repo": "winningtrendingbots/Kraken-Trading",
            "sync_type": "automated",
            "files_synced": $csv_count,
            "status": "$([ $csv_count -gt 0 ] && echo 'active' || echo 'waiting_for_data')"
          }
          EOF
          
          echo "üìä Metadata creado:"
          cat sync_metadata.json
      
      - name: Commit and push
        run: |
          cd dashboard
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "üì≠ No hay cambios para commitear"
            echo "CHANGES=false" >> $GITHUB_ENV
          else
            timestamp=$(date -u +%Y-%m-%d\ %H:%M:%S)
            git commit -m "üîÑ Data sync: $timestamp UTC"
            git push
            echo "‚úÖ Cambios pusheados exitosamente"
            echo "CHANGES=true" >> $GITHUB_ENV
          fi
      
      - name: Post Checkout trading repo
        if: env.CHANGES == 'true'
        run: echo "‚úÖ Sincronizaci√≥n completada con √©xito"
      
      - name: Post Checkout dashboard repo
        if: env.CHANGES == 'false'
        run: echo "‚ÑπÔ∏è No hubo cambios en esta sincronizaci√≥n"
