name: Predict & Trade (Mejorado)

on:
  schedule:
    - cron: '*/15 * * * *'  # Cada 5 minutos y si n va bien cada 15
  workflow_dispatch:

permissions:
  contents: write

jobs:
  predict-and-trade:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Log execution
        run: |
          echo "üïê Workflow ejecutado a: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üìã Trigger: ${{ github.event_name }}"
          echo "üåø Branch: ${{ github.ref }}"
      - name: Checkout
        uses: actions/checkout@v4
      
      # ========================================
      # PASO 1: Verificar modelo
      # ========================================
      - name: Check if model exists
        id: check
        run: |
          echo "üîç Verificando modelo..."
          
          if [ -d "ADAUSD_MODELS" ] && [ "$(ls -A ADAUSD_MODELS/*.pth 2>/dev/null)" ]; then
            echo "‚úÖ Modelo encontrado"
            echo "has_model=true" >> $GITHUB_OUTPUT
            
            # Mostrar info del modelo
            if [ -f "LAST_TRAINING.txt" ]; then
              echo "üìã √öltimo entrenamiento:"
              cat LAST_TRAINING.txt
            fi
          else
            echo "‚ö†Ô∏è No hay modelo entrenado"
            echo "has_model=false" >> $GITHUB_OUTPUT
          fi
      
      # ========================================
      # PASO 2: Esperar modelo (si no existe)
      # ========================================
      - name: Wait for model
        if: steps.check.outputs.has_model == 'false'
        run: |
          echo ""
          echo "‚è≥ ============================================"
          echo "   NO HAY MODELO ENTRENADO"
          echo "============================================"
          echo ""
          echo "üéØ Para empezar a predecir:"
          echo "   1. Ve a 'Actions' ‚Üí 'Train Model'"
          echo "   2. Presiona 'Run workflow'"
          echo "   3. Espera ~15-20 minutos"
          echo ""
          echo "üìä Una vez entrenado, este workflow:"
          echo "   ‚Ä¢ Generar√° predicciones cada hora"
          echo "   ‚Ä¢ Ejecutar√° trades autom√°ticamente"
          echo "   ‚Ä¢ Monitorear√° √≥rdenes cada 15 min"
          echo ""
          echo "‚ö†Ô∏è Este workflow se saltar√° hasta que exista el modelo"
          echo ""
          exit 0
      
      # ========================================
      # PASO 3: Setup Python (solo si hay modelo)
      # ========================================
      - name: Setup Python
        if: steps.check.outputs.has_model == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        if: steps.check.outputs.has_model == 'true'
        run: |
          echo "üì¶ Instalando dependencias..."
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # ========================================
      # PASO 4: Generar predicciones
      # ========================================
      - name: Generate predictions
        if: steps.check.outputs.has_model == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üîÆ ============================================"
          echo "   GENERANDO PREDICCIONES"
          echo "============================================"
          echo ""
          
          # Ejecutar predicci√≥n con manejo de errores
          if python predict_and_filter.py; then
            echo ""
            echo "‚úÖ Predicci√≥n completada"
            
            # Verificar que se gener√≥ el CSV
            if [ -f "trading_signals.csv" ]; then
              echo "‚úÖ Se√±ales guardadas en trading_signals.csv"
              
              # Mostrar √∫ltima se√±al
              echo ""
              echo "üìä √öltima se√±al generada:"
              tail -n 1 trading_signals.csv
            else
              echo "‚ö†Ô∏è No se gener√≥ trading_signals.csv"
              exit 1
            fi
          else
            echo ""
            echo "‚ùå Error en predict_and_filter.py"
            exit 1
          fi
      
      # ========================================
      # PASO 5: Ejecutar trades
      # ========================================
      - name: Execute trades
        if: steps.check.outputs.has_model == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üíº ============================================"
          echo "   EJECUTANDO ESTRATEGIA DE TRADING"
          echo "============================================"
          echo ""
          
          # Ejecutar trader con manejo de errores
          if python trading_orchestrator.py; then
            echo ""
            echo "‚úÖ Trading ejecutado correctamente"
            
            # Mostrar √≥rdenes abiertas (si existen)
            if [ -f "open_orders.json" ]; then
              echo ""
              echo "üìã √ìrdenes abiertas:"
              cat open_orders.json | python -m json.tool 2>/dev/null || cat open_orders.json
            else
              echo "‚ÑπÔ∏è No hay √≥rdenes abiertas"
            fi
          else
            echo ""
            echo "‚ö†Ô∏è Error en trading_orchestrator.py (no cr√≠tico)"
            # No hacemos exit 1 aqu√≠ porque puede ser normal (ej: sin se√±ales v√°lidas)
          fi
      
      # ========================================
      # PASO 6: Guardar resultados
      # ========================================
      - name: Save signals and orders
        if: steps.check.outputs.has_model == 'true'
        run: |
          echo ""
          echo "üíæ ============================================"
          echo "   GUARDANDO DATOS"
          echo "============================================"
          echo ""
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # A√±adir todos los archivos relevantes
          git add trading_signals.csv 2>/dev/null || true
          git add orders_executed.csv 2>/dev/null || true
          git add prediction_tracker.csv 2>/dev/null || true
          git add open_orders.json 2>/dev/null || true
          git add kraken_trades.csv 2>/dev/null || true
          git add risk_config.json 2>/dev/null || true
          git add *.json 2>/dev/null || true
          
          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No hay nuevos datos que guardar"
          else
            # Mostrar qu√© se guardar√°
            echo "üìù Archivos modificados:"
            git diff --staged --name-only
            
            # Commit con timestamp
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ü§ñ Trading cycle: $TIMESTAMP"
            
            # Push con retry
            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              if git push; then
                echo ""
                echo "‚úÖ Datos guardados correctamente"
                break
              else
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "‚ö†Ô∏è Reintentando push ($i/$MAX_RETRIES)..."
                  sleep 2
                  git pull --rebase
                else
                  echo "‚ùå Error al guardar datos despu√©s de $MAX_RETRIES intentos"
                  exit 1
                fi
              fi
            done
          fi
      
      # ========================================
      # PASO 7: Resumen final
      # ========================================
      - name: Summary
        if: always() && steps.check.outputs.has_model == 'true'
        run: |
          echo ""
          echo "üìä ============================================"
          echo "   RESUMEN DE EJECUCI√ìN"
          echo "============================================"
          echo ""
          
          # Contar archivos generados
          echo "üìÅ Archivos generados:"
          [ -f "trading_signals.csv" ] && echo "  ‚úÖ trading_signals.csv" || echo "  ‚ùå trading_signals.csv"
          [ -f "prediction_tracker.csv" ] && echo "  ‚úÖ prediction_tracker.csv" || echo "  ‚ùå prediction_tracker.csv"
          [ -f "orders_executed.csv" ] && echo "  ‚úÖ orders_executed.csv" || echo "  ‚ö†Ô∏è orders_executed.csv (sin trades)"
          [ -f "kraken_trades.csv" ] && echo "  ‚úÖ kraken_trades.csv" || echo "  ‚ö†Ô∏è kraken_trades.csv (sin trades cerrados)"
          [ -f "open_orders.json" ] && echo "  ‚úÖ open_orders.json" || echo "  ‚ö†Ô∏è open_orders.json (sin posiciones)"
          
          echo ""
          echo "üïê Pr√≥xima ejecuci√≥n: En 5 minutos"
          echo ""
