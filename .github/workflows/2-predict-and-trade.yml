name: üîÆ Predict & Trade (Enhanced - 5min)

on:
  schedule:
    - cron: '*/5 * * * *'  # ‚úÖ Cada 5 minutos
  workflow_dispatch:
    inputs:
      use_legacy_predictor:
        description: 'Usar predictor antiguo (predict_and_filter.py)'
        type: boolean
        default: false
      force_evaluation:
        description: 'Forzar evaluaci√≥n de predicciones'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  predict-and-trade:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üìã Log execution
        run: |
          echo "üïê Workflow ejecutado: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üìã Trigger: ${{ github.event_name }}"
          echo "üåø Branch: ${{ github.ref }}"
          echo "üîß Predictor: ${{ github.event.inputs.use_legacy_predictor == 'true' && 'Legacy' || 'Enhanced (MQL5 - 5min)' }}"
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      # ========================================
      # PASO 1: Verificar modelo
      # ========================================
      - name: üîç Check if model exists
        id: check
        run: |
          echo "üîé Verificando modelo..."
          
          if [ -d "ADAUSD_MODELS" ] && [ "$(ls -A ADAUSD_MODELS/*.pth 2>/dev/null)" ]; then
            echo "‚úÖ Modelo encontrado"
            echo "has_model=true" >> $GITHUB_OUTPUT
            
            # Mostrar info del modelo
            if [ -f "ADAUSD_MODELS/training_summary.json" ]; then
              echo "üìä Informaci√≥n del modelo:"
              python3 << 'PYEOF'
          import json
          try:
              with open('ADAUSD_MODELS/training_summary.json', 'r') as f:
                  data = json.load(f)
              print(f"  Entrenado: {data.get('timestamp', 'N/A')}")
              if 'overfitting_diagnosis' in data:
                  diag = data['overfitting_diagnosis']
                  print(f"  Gap Train-Test: {diag.get('gap_train_test', 'N/A')}")
                  print(f"  Status: {diag.get('status', 'N/A')}")
          except Exception as e:
              print(f"  (Error parseando summary: {e})")
          PYEOF
            fi
          else
            echo "‚ö†Ô∏è No hay modelo entrenado"
            echo "has_model=false" >> $GITHUB_OUTPUT
          fi
      
      # ========================================
      # PASO 2: Esperar modelo (si no existe)
      # ========================================
      - name: ‚è≥ Wait for model
        if: steps.check.outputs.has_model == 'false'
        run: |
          echo ""
          echo "‚è≥ ============================================"
          echo "   NO HAY MODELO ENTRENADO"
          echo "============================================"
          echo ""
          echo "üéØ Para empezar a predecir:"
          echo "   1. Ve a 'Actions' ‚Üí 'Train Model'"
          echo "   2. Presiona 'Run workflow'"
          echo "   3. Espera ~15-20 minutos"
          echo ""
          echo "üìä Una vez entrenado, este workflow:"
          echo "   ‚Ä¢ Generar√° predicciones cada 5 min"
          echo "   ‚Ä¢ Ejecutar√° trades autom√°ticamente"
          echo "   ‚Ä¢ Monitorear√° √≥rdenes cada 5 min"
          echo ""
          echo "‚ö†Ô∏è Este workflow se saltar√° hasta que exista el modelo"
          echo ""
          exit 0
      
      # ========================================
      # PASO 3: Setup Python
      # ========================================
      - name: üêç Setup Python
        if: steps.check.outputs.has_model == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        if: steps.check.outputs.has_model == 'true'
        run: |
          echo "üì¶ Instalando dependencias..."
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # ========================================
      # PASO 3.5: Evaluar predicciones antiguas
      # ========================================
      - name: üìä Evaluate old predictions
        if: steps.check.outputs.has_model == 'true' && (github.event.inputs.force_evaluation == 'true' || github.event.schedule == '0 */6 * * *')
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üìä ============================================"
          echo "   EVALUANDO PREDICCIONES ANTIGUAS"
          echo "============================================"
          echo ""
          
          if [ -f "evaluate_predictions.py" ]; then
            python evaluate_predictions.py || echo "‚ö†Ô∏è Error en evaluaci√≥n (no cr√≠tico)"
          else
            echo "‚ÑπÔ∏è evaluate_predictions.py no encontrado (saltando)"
          fi
      
      # ========================================
      # PASO 4: Generar predicciones
      # ========================================
      - name: üîÆ Generate predictions (Enhanced - 5min)
        if: steps.check.outputs.has_model == 'true' && github.event.inputs.use_legacy_predictor != 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üîÆ ============================================"
          echo "   GENERANDO PREDICCIONES (5 MINUTOS)"
          echo "============================================"
          echo ""
          echo "‚ú® Usando predict_enhanced_5min.py"
          echo "   - Timeframe: 5 minutos"
          echo "   - Normalizaci√≥n con 120 d√≠as"
          echo "   - Clasificaci√≥n multi-factor (H/L/C)"
          echo "   - Confianza din√°mica"
          echo ""
          
          # Verificar que existe el script
          if [ ! -f "predict_enhanced_5min.py" ]; then
            echo "‚ö†Ô∏è predict_enhanced_5min.py no encontrado"
            echo "üìù Creando versi√≥n adaptada..."
            
            # Aqu√≠ se crear√≠a el script adaptado si no existe
            # Por ahora, usar el enhanced normal
            if python predict_enhanced.py; then
              echo "‚úÖ Predicci√≥n completada (usando enhanced gen√©rico)"
            else
              echo "‚ùå Error en predicci√≥n"
              exit 1
            fi
          else
            # Ejecutar predicci√≥n mejorada para 5min
            if python predict_enhanced_5min.py; then
              echo ""
              echo "‚úÖ Predicci√≥n completada (5min)"
              
              # Verificar que se gener√≥ el CSV
              if [ -f "trading_signals.csv" ]; then
                echo "‚úÖ Se√±ales guardadas en trading_signals.csv"
                
                # Mostrar √∫ltima se√±al
                echo ""
                echo "üìä √öltima se√±al generada:"
                tail -n 1 trading_signals.csv
              else
                echo "‚ö†Ô∏è No se gener√≥ trading_signals.csv"
                exit 1
              fi
            else
              echo ""
              echo "‚ùå Error en predict_enhanced_5min.py"
              exit 1
            fi
          fi
      
      # Reemplazar los dos pasos de predicci√≥n por uno solo:
      - name: üîÆ Generate predictions (5min)
        if: steps.check.outputs.has_model == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üîÆ ============================================"
          echo "   GENERANDO PREDICCIONES (5 MINUTOS)"
          echo "============================================"
          echo ""
          
          python predict_enhanced_5min.py
          
          if python predict_and_filter.py; then
            echo ""
            echo "‚úÖ Predicci√≥n completada"
            
            if [ -f "trading_signals.csv" ]; then
              echo "‚úÖ Se√±ales guardadas en trading_signals.csv"
              echo ""
              echo "üìä √öltima se√±al generada:"
              tail -n 1 trading_signals.csv
            else
              echo "‚ö†Ô∏è No se gener√≥ trading_signals.csv"
              exit 1
            fi
          else
            echo ""
            echo "‚ùå Error en predict_and_filter.py"
            exit 1
          fi
      
      # ========================================
      # PASO 5: Ejecutar trades
      # ========================================
      - name: üíº Execute trades
        if: steps.check.outputs.has_model == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üíº ============================================"
          echo "   EJECUTANDO ESTRATEGIA DE TRADING (5min)"
          echo "============================================"
          echo ""
          
          if python trading_orchestrator.py; then
            echo ""
            echo "‚úÖ Trading ejecutado correctamente"
            
            if [ -f "open_orders.json" ]; then
              echo ""
              echo "üìã √ìrdenes abiertas:"
              cat open_orders.json | python3 -m json.tool 2>/dev/null || cat open_orders.json
            else
              echo "‚ÑπÔ∏è No hay √≥rdenes abiertas"
            fi
          else
            echo ""
            echo "‚ö†Ô∏è Error en trading_orchestrator.py (no cr√≠tico)"
          fi
      
      # ========================================
      # PASO 6: Guardar resultados
      # ========================================
      - name: üíæ Save signals and orders
        if: steps.check.outputs.has_model == 'true'
        run: |
          echo ""
          echo "üíæ ============================================"
          echo "   GUARDANDO DATOS"
          echo "============================================"
          echo ""
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add trading_signals.csv 2>/dev/null || true
          git add orders_executed.csv 2>/dev/null || true
          git add prediction_tracker.csv 2>/dev/null || true
          git add open_orders.json 2>/dev/null || true
          git add kraken_trades.csv 2>/dev/null || true
          git add risk_config.json 2>/dev/null || true
          git add *.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No hay nuevos datos que guardar"
          else
            echo "üìù Archivos modificados:"
            git diff --staged --name-only
            
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            PREDICTOR="${{ github.event.inputs.use_legacy_predictor == 'true' && 'legacy' || 'enhanced-5min' }}"
            git commit -m "ü§ñ Trading cycle [5min-$PREDICTOR]: $TIMESTAMP"
            
            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              if git push; then
                echo ""
                echo "‚úÖ Datos guardados correctamente"
                break
              else
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "‚ö†Ô∏è Reintentando push ($i/$MAX_RETRIES)..."
                  sleep 2
                  git pull --rebase
                else
                  echo "‚ùå Error al guardar datos despu√©s de $MAX_RETRIES intentos"
                  exit 1
                fi
              fi
            done
          fi
      
      # ========================================
      # PASO 7: Resumen final
      # ========================================
      - name: üìä Summary
        if: always() && steps.check.outputs.has_model == 'true'
        run: |
          echo ""
          echo "üìä ============================================"
          echo "   RESUMEN DE EJECUCI√ìN (5 MINUTOS)"
          echo "============================================"
          echo ""
          
          if [ "${{ github.event.inputs.use_legacy_predictor }}" = "true" ]; then
            echo "üîß Predictor: Legacy (predict_and_filter.py)"
          else
            echo "‚ú® Predictor: Enhanced 5min (predict_enhanced_5min.py)"
          fi
          echo ""
          
          echo "üìÅ Archivos generados:"
          [ -f "trading_signals.csv" ] && echo "  ‚úÖ trading_signals.csv" || echo "  ‚ùå trading_signals.csv"
          [ -f "prediction_tracker.csv" ] && echo "  ‚úÖ prediction_tracker.csv" || echo "  ‚ùå prediction_tracker.csv"
          [ -f "orders_executed.csv" ] && echo "  ‚úÖ orders_executed.csv" || echo "  ‚ö†Ô∏è orders_executed.csv (sin trades)"
          [ -f "kraken_trades.csv" ] && echo "  ‚úÖ kraken_trades.csv" || echo "  ‚ö†Ô∏è kraken_trades.csv (sin trades cerrados)"
          [ -f "open_orders.json" ] && echo "  ‚úÖ open_orders.json" || echo "  ‚ö†Ô∏è open_orders.json (sin posiciones)"
          
          echo ""
          
          if [ -f "prediction_tracker.csv" ]; then
            echo "üìà Estad√≠sticas de predicciones:"
            python3 << 'PYEOF'
          import pandas as pd
          try:
              df = pd.read_csv('prediction_tracker.csv')
              total = len(df)
              evaluated = df['actual_close'].notna().sum()
              
              print(f"  Total predicciones: {total}")
              print(f"  Evaluadas: {evaluated}")
              
              if evaluated > 0:
                  avg_accuracy = df[df['actual_close'].notna()]['pred_accuracy_%'].mean()
                  print(f"  Accuracy promedio: {avg_accuracy:.2f}%")
          except Exception as e:
              print(f"  Error: {e}")
          PYEOF
          fi
          
          echo ""
          echo "üïê Pr√≥xima ejecuci√≥n: En 5 minutos"
          echo ""
