name: ‚ö° Fast Trading (5 min)

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fast-trading:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
      - name: üìã Log execution
        run: |
          echo "üïê Ejecutado: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "‚ö° Modo: Trading R√°pido (5min)"
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      # ========================================
      # VERIFICAR MODELO
      # ========================================
      - name: ‚úÖ Check model
        id: check
        run: |
          if [ -d "ADAUSD_MODELS" ] && [ "$(ls -A ADAUSD_MODELS/*.pth 2>/dev/null)" ]; then
            echo "‚úÖ Modelo encontrado"
            echo "has_model=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No hay modelo - ejecuta Train Model primero"
            echo "has_model=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ‚è∏Ô∏è Wait for model
        if: steps.check.outputs.has_model == 'false'
        run: |
          echo ""
          echo "‚è∏Ô∏è =========================================="
          echo "   NO HAY MODELO ENTRENADO"
          echo "=========================================="
          echo ""
          echo "Para empezar:"
          echo "1. Ve a Actions ‚Üí 'Train Model'"
          echo "2. Run workflow"
          echo "3. Espera ~15-20 min"
          echo ""
          exit 0
      
      # ========================================
      # SETUP PYTHON
      # ========================================
      - name: üêç Setup Python
        if: steps.check.outputs.has_model == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        if: steps.check.outputs.has_model == 'true'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # ========================================
      # PREDICCI√ìN R√ÅPIDA (5 MIN)
      # ========================================
      - name: üîÆ Generate prediction (5min)
        if: steps.check.outputs.has_model == 'true'
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üîÆ =========================================="
          echo "   PREDICCI√ìN R√ÅPIDA (5 MIN)"
          echo "=========================================="
          echo ""
          
          if python predict_5min.py; then
            echo "‚úÖ Predicci√≥n completada"
            
            if [ -f "trading_signals.csv" ]; then
              echo "‚úÖ Se√±al guardada"
              echo ""
              echo "üìä √öltima se√±al:"
              tail -n 1 trading_signals.csv
            fi
          else
            echo "‚ö†Ô∏è Error en predicci√≥n (no cr√≠tico)"
          fi
      
      # ========================================
      # EJECUTAR TRADING
      # ========================================
      - name: üíº Execute trading
        if: steps.check.outputs.has_model == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "üíº =========================================="
          echo "   EJECUTANDO ESTRATEGIA"
          echo "=========================================="
          echo ""
          
          if python trading_orchestrator.py; then
            echo "‚úÖ Estrategia ejecutada"
          else
            echo "‚ö†Ô∏è Estrategia skip (sin se√±ales v√°lidas)"
          fi
      
      # ========================================
      # GUARDAR DATOS
      # ========================================
      - name: üíæ Save data
        if: steps.check.outputs.has_model == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # A√±adir archivos relevantes
          git add trading_signals.csv 2>/dev/null || true
          git add orders_executed.csv 2>/dev/null || true
          git add open_orders.json 2>/dev/null || true
          git add kraken_trades.csv 2>/dev/null || true
          git add risk_config.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios"
          else
            timestamp=$(date -u +"%H:%M UTC")
            git commit -m "‚ö° Fast trading: $timestamp"
            
            # Retry logic
            for i in {1..3}; do
              if git push; then
                echo "‚úÖ Datos guardados"
                break
              else
                if [ $i -lt 3 ]; then
                  echo "‚ö†Ô∏è Retry $i/3..."
                  sleep 2
                  git pull --rebase
                fi
              fi
            done
          fi
      
      # ========================================
      # RESUMEN
      # ========================================
      - name: üìä Summary
        if: always() && steps.check.outputs.has_model == 'true'
        run: |
          echo ""
          echo "üìä =========================================="
          echo "   RESUMEN"
          echo "=========================================="
          echo ""
          
          echo "üìù Archivos:"
          [ -f "trading_signals.csv" ] && echo "  ‚úÖ trading_signals.csv" || echo "  ‚ùå trading_signals.csv"
          [ -f "open_orders.json" ] && echo "  ‚úÖ open_orders.json" || echo "  ‚ö†Ô∏è open_orders.json (sin posiciones)"
          [ -f "kraken_trades.csv" ] && echo "  ‚úÖ kraken_trades.csv" || echo "  ‚ö†Ô∏è kraken_trades.csv (sin trades)"
          
          echo ""
          echo "üïê Pr√≥xima ejecuci√≥n: En 5 minutos"
          echo ""
