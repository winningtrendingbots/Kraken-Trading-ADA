name: ğŸš€ Train Enhanced OHLCV Model ğŸ¤–

on:
  schedule:
    - cron: '0 2 * * *'  # Diario a las 2 AM UTC
  workflow_dispatch:
    inputs:
      force_train:
        description: 'Forzar reentrenamiento'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  train-enhanced-ohlcv:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Check model age
        id: check
        run: |
          echo "Verificando edad del modelo mejorado OHLCV..."
          
          if [ "${{ github.event.inputs.force_train }}" = "true" ]; then
            echo "ğŸ”§ Entrenamiento forzado"
            echo "should_train=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -d "ADAUSD_MODELS" ] && [ -f "ADAUSD_MODELS/adausd_enhanced_lstm_ohlcv.pth" ]; then
            last_train=$(stat -c %Y "ADAUSD_MODELS/adausd_enhanced_lstm_ohlcv.pth")
            current_time=$(date +%s)
            age=$((current_time - last_train))
            days=$((age / 86400))
            
            echo "ğŸ“Š Modelo tiene $days dÃ­as"
            
            if [ $days -ge 7 ]; then
              echo "ğŸ”„ Reentrenamiento necesario (â‰¥7 dÃ­as)"
              echo "should_train=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Modelo vigente ($days dÃ­as)"
              echo "should_train=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ No existe modelo mejorado"
            echo "should_train=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ Setup Python
        if: steps.check.outputs.should_train == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.check.outputs.should_train == 'true'
        run: |
          echo "ğŸ“¦ Instalando dependencias..."
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§  Train Enhanced OHLCV Model
        if: steps.check.outputs.should_train == 'true'
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "ğŸ”¥ ============================================"
          echo "   LSTM MEJORADO - PREDICCIÃ“N OHLCV"
          echo "============================================"
          echo ""
          
          # Verificar archivos Python disponibles
          echo "ğŸ“‚ Verificando script..."
          SCRIPT_NAME=""
          
          if [ -f "adausd_lstm_ohlcv.py" ]; then
            SCRIPT_NAME="adausd_lstm_ohlcv.py"
          elif [ -f "adausd_lstm_ohlcv.py" ]; then
            SCRIPT_NAME="adausd_lstm_ohlcv.py"
            echo "âš ï¸ Usando versiÃ³n anterior (no mejorada)"
          else
            echo "âŒ Error: No se encontrÃ³ script de entrenamiento"
            ls -la *.py 2>/dev/null || echo "Sin archivos .py en raÃ­z"
            find . -name "*lstm*.py" -type f
            exit 1
          fi
          
          echo "âœ… Script: $SCRIPT_NAME"
          echo ""
          echo "âœ¨ MEJORAS IMPLEMENTADAS:"
          echo "   ğŸ”¹ Volumen con log-normalizaciÃ³n"
          echo "   ğŸ”¹ Scalers separados para precio/volumen"
          echo "   ğŸ”¹ Arquitectura robusta (128 hidden, 3 layers)"
          echo "   ğŸ”¹ Cabezas separadas (precio + volumen)"
          echo "   ğŸ”¹ +20 indicadores tÃ©cnicos avanzados"
          echo "   ğŸ”¹ Loss balanceado (precio 1.0, volumen 0.1)"
          echo "   ğŸ”¹ SEQ_LEN: 90 (mÃ¡s contexto)"
          echo "   ğŸ”¹ LR: 0.0001 (convergencia estable)"
          echo "   ğŸ”¹ Batch: 64 (mejor gradientes)"
          echo ""
          
          python "$SCRIPT_NAME"
          
          echo ""
          echo "âœ… Entrenamiento completado"
      
      - name: ğŸ“Š Validate metrics
        if: steps.check.outputs.should_train == 'true'
        run: |
          echo ""
          echo "ğŸ” Validando mÃ©tricas del modelo mejorado..."
          
          CONFIG_FILE=""
          if [ -f "ADAUSD_MODELS/config_enhanced_ohlcv.json" ]; then
            CONFIG_FILE="ADAUSD_MODELS/config_enhanced_ohlcv.json"
          elif [ -f "ADAUSD_MODELS/config_hybrid_ohlcv.json" ]; then
            CONFIG_FILE="ADAUSD_MODELS/config_hybrid_ohlcv.json"
          fi
          
          if [ -z "$CONFIG_FILE" ]; then
            echo "âŒ No se encontrÃ³ archivo de configuraciÃ³n"
            exit 0
          fi
          
          echo "âœ… Config: $CONFIG_FILE"
          echo ""
          echo "ğŸ“Š MÃ‰TRICAS DEL MODELO:"
          python3 <<PYEOF
          import json
          import sys
          
          try:
              with open('$CONFIG_FILE', 'r') as f:
                  config = json.load(f)
              
              metrics = config.get('metrics_test', {})
              
              if not metrics:
                  print("   âš ï¸ No hay mÃ©tricas disponibles")
                  sys.exit(0)
              
              # Separar precio y volumen
              price_targets = ['delta_open', 'delta_high', 'delta_low', 'delta_close']
              volume_target = 'delta_volume'
              
              print("   ğŸ¯ PRECIO (OHLC):")
              print("   Target          RÂ²        MAE       Accuracy")
              print("   -------------------------------------------------")
              
              price_r2_sum = 0
              price_acc_sum = 0
              price_count = 0
              
              for target in price_targets:
                  if target in metrics:
                      data = metrics[target]
                      r2 = data.get('R2', 0)
                      mae = data.get('MAE', 0)
                      acc = data.get('Direction_Accuracy', 0)
                      print(f"   {target:14} {r2:8.4f}   {mae:8.6f}   {acc:6.2f}%")
                      price_r2_sum += r2
                      price_acc_sum += acc
                      price_count += 1
              
              if price_count > 0:
                  avg_price_r2 = price_r2_sum / price_count
                  avg_price_acc = price_acc_sum / price_count
                  print(f"\n   ğŸ“ˆ Precio - RÂ² promedio: {avg_price_r2:.4f}")
                  print(f"   ğŸ¯ Precio - Accuracy promedio: {avg_price_acc:.2f}%")
              
              # Volumen
              if volume_target in metrics:
                  print("\n   ğŸ’§ VOLUMEN:")
                  vol_data = metrics[volume_target]
                  vol_r2 = vol_data.get('R2', 0)
                  vol_mae = vol_data.get('MAE', 0)
                  vol_acc = vol_data.get('Direction_Accuracy', 0)
                  print(f"   RÂ²: {vol_r2:8.4f}")
                  print(f"   MAE: {vol_mae:8.6f}")
                  print(f"   Accuracy: {vol_acc:6.2f}%")
              
              # EvaluaciÃ³n general
              print("\n   ğŸ“Š EVALUACIÃ“N:")
              if price_count > 0:
                  if avg_price_r2 < 0:
                      print("   âš ï¸  RÂ² negativo - modelo no converge bien")
                      print("   ğŸ’¡ Sugerencias:")
                      print("      - Aumentar Ã©pocas de entrenamiento")
                      print("      - Ajustar learning rate")
                      print("      - Revisar features engineering")
                  elif avg_price_r2 < 0.3:
                      print("   âš ï¸  RÂ² bajo - rendimiento limitado")
                  elif avg_price_r2 < 0.5:
                      print("   âœ… RÂ² aceptable - modelo funcional")
                  elif avg_price_r2 < 0.7:
                      print("   âœ… RÂ² bueno - buen rendimiento")
                  else:
                      print("   ğŸ‰ RÂ² excelente - alto rendimiento")
                  
                  if avg_price_acc > 55:
                      print(f"   âœ… Accuracy direccional buena ({avg_price_acc:.1f}%)")
                  else:
                      print(f"   âš ï¸  Accuracy direccional baja ({avg_price_acc:.1f}%)")
              
          except FileNotFoundError:
              print(f"   âŒ No se encontrÃ³: $CONFIG_FILE")
          except Exception as e:
              print(f"   âŒ Error: {e}")
              import traceback
              traceback.print_exc()
          PYEOF
      
      - name: ğŸ’¾ Commit trained model
        if: steps.check.outputs.should_train == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # AÃ±adir archivos del modelo mejorado
          git add ADAUSD_MODELS/adausd_enhanced_lstm_ohlcv.pth 2>/dev/null || true
          git add ADAUSD_MODELS/config_enhanced_ohlcv.json 2>/dev/null || true
          git add ADAUSD_MODELS/scaler_input_enhanced.pkl 2>/dev/null || true
          git add ADAUSD_MODELS/scaler_output_price_enhanced.pkl 2>/dev/null || true
          git add ADAUSD_MODELS/scaler_output_volume_enhanced.pkl 2>/dev/null || true
          git add adausd_enhanced_ohlcv_results.png 2>/dev/null || true
          
          # TambiÃ©n archivos anteriores por compatibilidad
          git add ADAUSD_MODELS/adausd_hybrid_lstm_ohlcv.pth 2>/dev/null || true
          git add ADAUSD_MODELS/config_hybrid_ohlcv.json 2>/dev/null || true
          git add adausd_hybrid_ohlcv_results.png 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No hay cambios para commitear"
          else
            echo "ğŸ“‹ Archivos a commitear:"
            git diff --staged --name-only
            
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸš€ Enhanced OHLCV Model trained: $TIMESTAMP"
            
            # Push con retry
            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              if git push; then
                echo ""
                echo "âœ… Modelo mejorado guardado en repositorio"
                break
              else
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "âš ï¸ Reintentando push ($i/$MAX_RETRIES)..."
                  sleep 2
                  git pull --rebase
                else
                  echo "âŒ Error al guardar modelo despuÃ©s de $MAX_RETRIES intentos"
                  exit 1
                fi
              fi
            done
          fi
      
      - name: ğŸ“Š Training summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "${{ steps.check.outputs.should_train }}" = "true" ]; then
            echo "  âœ… MODELO MEJORADO OHLCV ENTRENADO"
            echo ""
            echo "ğŸ“ Archivos generados:"
            
            # Verificar modelo mejorado
            if [ -f "ADAUSD_MODELS/adausd_enhanced_lstm_ohlcv.pth" ]; then
              echo "   âœ… adausd_enhanced_lstm_ohlcv.pth (MEJORADO)"
            elif [ -f "ADAUSD_MODELS/adausd_hybrid_lstm_ohlcv.pth" ]; then
              echo "   âœ… adausd_hybrid_lstm_ohlcv.pth (versiÃ³n anterior)"
            else
              echo "   âŒ Modelo no encontrado"
            fi
            
            # Verificar config
            if [ -f "ADAUSD_MODELS/config_enhanced_ohlcv.json" ]; then
              echo "   âœ… config_enhanced_ohlcv.json"
              CONFIG_FILE="ADAUSD_MODELS/config_enhanced_ohlcv.json"
            elif [ -f "ADAUSD_MODELS/config_hybrid_ohlcv.json" ]; then
              echo "   âœ… config_hybrid_ohlcv.json"
              CONFIG_FILE="ADAUSD_MODELS/config_hybrid_ohlcv.json"
            else
              CONFIG_FILE=""
            fi
            
            # Verificar grÃ¡ficas
            if [ -f "adausd_enhanced_ohlcv_results.png" ]; then
              echo "   âœ… adausd_enhanced_ohlcv_results.png"
            elif [ -f "adausd_hybrid_ohlcv_results.png" ]; then
              echo "   âœ… adausd_hybrid_ohlcv_results.png"
            fi
            
            # Mostrar resumen de mÃ©tricas
            if [ -n "$CONFIG_FILE" ]; then
              echo ""
              echo "ğŸ“Š Resumen de mÃ©tricas:"
              python3 <<PYEOF
          import json
          try:
              with open('$CONFIG_FILE', 'r') as f:
                  config = json.load(f)
              
              metrics = config.get('metrics_test', {})
              if metrics:
                  # Precio
                  price_targets = ['delta_open', 'delta_high', 'delta_low', 'delta_close']
                  print("   ğŸ¯ PRECIO:")
                  for t in price_targets:
                      if t in metrics:
                          r2 = metrics[t].get('R2', 0)
                          acc = metrics[t].get('Direction_Accuracy', 0)
                          print(f"      {t:14} RÂ²: {r2:6.4f}  Acc: {acc:5.2f}%")
                  
                  # Promedio precio
                  price_r2 = [metrics[t]['R2'] for t in price_targets if t in metrics]
                  if price_r2:
                      avg_r2 = sum(price_r2) / len(price_r2)
                      print(f"\n   ğŸ“ˆ RÂ² promedio precio: {avg_r2:.4f}")
                  
                  # Volumen
                  if 'delta_volume' in metrics:
                      vol_r2 = metrics['delta_volume'].get('R2', 0)
                      vol_acc = metrics['delta_volume'].get('Direction_Accuracy', 0)
                      print(f"\n   ğŸ’§ VOLUMEN:")
                      print(f"      RÂ²: {vol_r2:6.4f}  Acc: {vol_acc:5.2f}%")
                  
                  # Info adicional
                  if 'training_time_minutes' in config:
                      print(f"\n   â±ï¸  Tiempo: {config['training_time_minutes']:.1f} min")
                  
                  if 'total_epochs' in config:
                      print(f"   ğŸ”„ Ã‰pocas: {config['total_epochs']}")
          except:
              pass
          PYEOF
            fi
          else
            echo "  â„¹ï¸ ENTRENAMIENTO NO NECESARIO"
            if [ -f "ADAUSD_MODELS/adausd_enhanced_lstm_ohlcv.pth" ]; then
              last_train=$(stat -c %Y "ADAUSD_MODELS/adausd_enhanced_lstm_ohlcv.pth")
              current_time=$(date +%s)
              age=$((current_time - last_train))
              days=$((age / 86400))
              echo "  Modelo actual tiene $days dÃ­as"
            fi
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
