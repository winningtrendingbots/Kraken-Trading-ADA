name: ðŸ“Š Analytics & Reports

on:
  schedule:
    - cron: '0 23 * * *'
    - cron: '0 12 * * 0'
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Tipo de reporte'
        required: true
        type: choice
        options:
          - daily
          - weekly
          - full_analysis

permissions:
  contents: read

concurrency:
  group: analytics-reports
  cancel-in-progress: false

jobs:
  generate-analytics:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check data files
        run: |
          if [ ! -f "kraken_trades.csv" ]; then
            echo "timestamp,txid,side,entry_price,close_price,volume,tp,sl,close_reason,time_open_min,pnl_usd,pnl_%" > kraken_trades.csv
          fi
          
          if [ ! -f "trading_signals.csv" ]; then
            echo "timestamp,current_price,pred_high,pred_low,pred_close,pred_change_%,atr,volatility,trend,signal,confidence" > trading_signals.csv
          fi
          
          if [ ! -f "orders_executed.csv" ]; then
            echo "timestamp,txid,side,entry_price,volume,tp,sl,confidence,order_executed,order_type" > orders_executed.csv
          fi
      
      - name: Generate analytics
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python analytics.py
      
      - name: Upload chart
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trading-analytics-${{ github.run_number }}
          path: trading_analytics.png
          retention-days: 30
      
      - name: Create daily report script
        if: github.event.schedule == '0 23 * * *' || github.event.inputs.report_type == 'daily'
        run: |
          cat > daily_report.py << 'EOFPYTHON'
          import pandas as pd
          import os
          import requests
          from datetime import datetime
          
          TELEGRAM_API = os.environ.get("TELEGRAM_API")
          CHAT_ID = os.environ.get("CHAT_ID")
          
          def send_telegram(msg):
              try:
                  url = f"https://api.telegram.org/bot{TELEGRAM_API}/sendMessage"
                  requests.post(url, data={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown"}, timeout=10)
              except Exception as e:
                  print(f"Error: {e}")
          
          report = f"ðŸ“Š *Reporte Diario - {datetime.now().strftime('%Y-%m-%d')}*\n\n"
          
          if os.path.exists("kraken_trades.csv"):
              df = pd.read_csv("kraken_trades.csv")
              if len(df) > 0:
                  df["timestamp"] = pd.to_datetime(df["timestamp"])
                  today = df[df["timestamp"].dt.date == datetime.now().date()]
                  
                  if len(today) > 0:
                      pnl = today["pnl_usd"].sum()
                      wins = (today["pnl_usd"] > 0).sum()
                      total = len(today)
                      wr = (wins / total * 100) if total > 0 else 0
                      
                      report += f"ðŸ’¼ TRADING HOY:\n"
                      report += f"Trades: {total}\n"
                      report += f"Ganadas: {wins} ({wr:.1f}%)\n"
                      report += f"P&L: ${pnl:.2f}\n\n"
                  
                  all_pnl = df["pnl_usd"].sum()
                  all_wins = (df["pnl_usd"] > 0).sum()
                  all_total = len(df)
                  all_wr = (all_wins / all_total * 100) if all_total > 0 else 0
                  
                  report += f"ðŸ“ˆ TOTALES:\n"
                  report += f"Trades: {all_total}\n"
                  report += f"Win Rate: {all_wr:.1f}%\n"
                  report += f"P&L: ${all_pnl:.2f}\n"
          
          send_telegram(report)
          print(report)
          EOFPYTHON
      
      - name: Run daily report
        if: github.event.schedule == '0 23 * * *' || github.event.inputs.report_type == 'daily'
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python daily_report.py
      
      - name: Create weekly report script
        if: github.event.schedule == '0 12 * * 0' || github.event.inputs.report_type == 'weekly'
        run: |
          cat > weekly_report.py << 'EOFPYTHON'
          import pandas as pd
          import os
          import requests
          from datetime import datetime, timedelta
          
          TELEGRAM_API = os.environ.get("TELEGRAM_API")
          CHAT_ID = os.environ.get("CHAT_ID")
          
          def send_telegram(msg):
              try:
                  url = f"https://api.telegram.org/bot{TELEGRAM_API}/sendMessage"
                  requests.post(url, data={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown"}, timeout=10)
              except Exception as e:
                  print(f"Error: {e}")
          
          report = f"ðŸ“Š *Reporte Semanal*\n"
          report += f"ðŸ“… {(datetime.now() - timedelta(days=7)).strftime('%d/%m')} - {datetime.now().strftime('%d/%m/%Y')}\n\n"
          
          if os.path.exists("kraken_trades.csv"):
              df = pd.read_csv("kraken_trades.csv")
              if len(df) > 0:
                  df["timestamp"] = pd.to_datetime(df["timestamp"])
                  week_ago = datetime.now() - timedelta(days=7)
                  week = df[df["timestamp"] >= week_ago]
                  
                  if len(week) > 0:
                      pnl = week["pnl_usd"].sum()
                      wins = (week["pnl_usd"] > 0).sum()
                      losses = (week["pnl_usd"] <= 0).sum()
                      wr = (wins / len(week) * 100) if len(week) > 0 else 0
                      
                      report += f"ðŸ’¼ TRADING SEMANA:\n"
                      report += f"Trades: {len(week)}\n"
                      report += f"Win Rate: {wr:.1f}%\n"
                      report += f"P&L: ${pnl:.2f}\n"
          
          send_telegram(report)
          print(report)
          EOFPYTHON
      
      - name: Run weekly report
        if: github.event.schedule == '0 12 * * 0' || github.event.inputs.report_type == 'weekly'
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python weekly_report.py

  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check system health
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "Verificando sistema..."
          
          issues=""
          
          [ ! -d "ADAUSD_MODELS" ] && issues="${issues}Falta ADAUSD_MODELS\n"
          [ ! -f "ADAUSD_1h_data.csv" ] && issues="${issues}Falta CSV\n"
          
          if [ -n "$issues" ]; then
            echo -e "$issues"
          else
            echo "Sistema OK"
          fi
