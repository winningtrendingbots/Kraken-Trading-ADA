name: ğŸ§  Train Model

on:
  schedule:
    - cron: '0 2 * * *'  # 1 vez al dÃ­a a las 2 AM UTC
  workflow_dispatch:
    inputs:
      force_train:
        description: 'Forzar reentrenamiento'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Check if training needed
        id: check
        run: |
          echo "ğŸ” Verificando si necesita reentrenamiento..."
          
          # Siempre entrenar si es manual y force_train=true
          if [ "${{ github.event.inputs.force_train }}" = "true" ]; then
            echo "ğŸ”„ Entrenamiento forzado"
            echo "should_train=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Verificar si existe modelo
          if [ -d "ADAUSD_MODELS" ] && [ "$(ls -A ADAUSD_MODELS/*.keras 2>/dev/null)" ]; then
            # Verificar antigÃ¼edad (reentrenar cada 7 dÃ­as)
            last_train=$(find ADAUSD_MODELS -type f -name "*.keras" -printf '%T@\n' | sort -n | tail -1 2>/dev/null || echo "0")
            current_time=$(date +%s)
            age=$((current_time - ${last_train:-0}))
            days=$((age / 86400))
            
            echo "ğŸ“… Modelo tiene $days dÃ­as"
            
            if [ $days -gt 7 ]; then
              echo "ğŸ”„ Reentrenamiento necesario (>7 dÃ­as)"
              echo "should_train=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Modelo vigente ($days dÃ­as)"
              echo "should_train=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ No existe modelo, entrenar"
            echo "should_train=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ Setup Python
        if: steps.check.outputs.should_train == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.check.outputs.should_train == 'true'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§  Train LSTM model
        if: steps.check.outputs.should_train == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ğŸ§  Iniciando entrenamiento del modelo LSTM..."
          python adausd_lstm.py
          echo "âœ… Entrenamiento completado"
      
      - name: ğŸ’¾ Commit model
        if: steps.check.outputs.should_train == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add ADAUSD_MODELS/ ADAUSD_1h_data.csv *.png 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No hay cambios para commitear"
          else
            git commit -m "ğŸ§  Model trained $(date -u +%Y-%m-%d)"
            git push
            echo "âœ… Modelo guardado en repositorio"
          fi
      
      - name: ğŸ“Š Training summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.should_train }}" = "true" ]; then
            echo "âœ… Modelo entrenado exitosamente"
          else
            echo "â„¹ï¸ Entrenamiento no necesario (modelo vigente)"
          fi
