name: ğŸ‘€ Monitor Orders

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Check for open orders
        id: check
        run: |
          echo "ğŸ” Verificando Ã³rdenes abiertas..."
          
          if [ -f "open_orders.json" ]; then
            # Contar Ã³rdenes en el JSON
            orders=$(cat open_orders.json | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
            
            if [ "$orders" -gt 0 ]; then
              echo "ğŸ“Š $orders orden(es) abierta(s)"
              echo "has_orders=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… No hay Ã³rdenes abiertas"
              echo "has_orders=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ“­ Archivo de Ã³rdenes no existe"
            echo "has_orders=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ Setup Python
        if: steps.check.outputs.has_orders == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.check.outputs.has_orders == 'true'
        run: |
          pip install --upgrade pip
          pip install pandas requests
      
      - name: ğŸ‘€ Monitor positions
        if: steps.check.outputs.has_orders == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo ""
          echo "ğŸ‘€ ============================================"
          echo "   MONITOREANDO POSICIONES"
          echo "============================================"
          echo ""
          
          python monitor_orders.py
          
          echo ""
          echo "âœ… Monitoreo completado"
      
      - name: ğŸ’¾ Save changes
        if: steps.check.outputs.has_orders == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # AÃ±adir archivos actualizados
          git add open_orders.json 2>/dev/null || true
          git add kraken_trades.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Sin cambios que guardar"
          else
            timestamp=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸ‘€ Orders monitored: $timestamp"
            git push
            echo "âœ… Cambios guardados"
          fi
      
      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š ============================================"
          echo "   RESUMEN"
          echo "============================================"
          echo ""
          
          if [ "${{ steps.check.outputs.has_orders }}" = "true" ]; then
            echo "âœ… Monitoreo ejecutado"
            
            if [ -f "kraken_trades.csv" ]; then
              trades=$(wc -l < kraken_trades.csv)
              echo "ğŸ“ˆ Trades cerrados: $((trades - 1))"
            fi
            
            if [ -f "open_orders.json" ]; then
              orders=$(cat open_orders.json | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
              echo "ğŸ“Š Ã“rdenes activas: $orders"
            fi
          else
            echo "â¸ï¸ Sin Ã³rdenes para monitorear"
          fi
          
          echo ""
          echo "ğŸ• PrÃ³ximo check: En 5 minutos"
          echo ""
