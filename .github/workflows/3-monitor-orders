name: ğŸ‘€ Monitor Orders

on:
  schedule:
    - cron: '*/4 * * * *'  # Cada 4 minutos
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Check for active trades
        id: check
        run: |
          # Verificar si existe archivo de trades
          if [ -f "kraken_trades.csv" ]; then
            lines=$(wc -l < kraken_trades.csv)
            if [ $lines -gt 1 ]; then
              echo "ğŸ“Š Trades file exists with $lines lines"
              echo "has_trades=true" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“­ Trades file empty"
              echo "has_trades=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ“­ No trades file yet"
            echo "has_trades=false" >> $GITHUB_OUTPUT
          fi
          
          # Verificar si existe archivo de Ã³rdenes ejecutadas
          if [ -f "orders_executed.csv" ]; then
            echo "âœ… Orders file exists"
            echo "has_orders=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“­ No orders yet"
            echo "has_orders=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ Setup Python
        if: steps.check.outputs.has_orders == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.check.outputs.has_orders == 'true'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ‘€ Monitor open orders
        if: steps.check.outputs.has_orders == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ğŸ‘€ Monitoreando Ã³rdenes abiertas..."
          python kraken_trader.py
          echo "âœ… Monitoreo completado"
      
      - name: ğŸ’¾ Update trades
        if: steps.check.outputs.has_orders == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Solo commitear si hay cambios en trades
          git add kraken_trades.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No hay actualizaciones de trades"
          else
            timestamp=$(date -u +%H:%M)
            git commit -m "ğŸ“ˆ Orders monitored $timestamp UTC"
            git push
            echo "âœ… Trades actualizados"
          fi
      
      - name: ğŸ“Š Monitor summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ "${{ steps.check.outputs.has_orders }}" = "true" ]; then
            echo "âœ… Monitoreo completado"
            echo "   - Ã“rdenes revisadas"
            echo "   - Estados actualizados"
          else
            echo "â³ Esperando primeras Ã³rdenes"
            echo "   Se crearÃ¡n cuando se ejecuten trades"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
