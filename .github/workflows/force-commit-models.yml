name: üîß Force Commit Model Files

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  force-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üìÇ Verificar archivos actuales
        run: |
          echo "üìÇ Archivos en ADAUSD_MODELS:"
          if [ -d "ADAUSD_MODELS" ]; then
            ls -lah ADAUSD_MODELS/
          else
            echo "‚ùå ADAUSD_MODELS no existe - necesitamos entrenar primero"
            exit 1
          fi
          
          echo ""
          echo "üìä Otros archivos importantes:"
          ls -lah ADAUSD_1h_data.csv adausd_results.png LAST_TRAINING.txt 2>/dev/null || echo "‚ö†Ô∏è Algunos archivos faltan"
      
      - name: üîß Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ‚úÖ Agregar archivos FORZADAMENTE
        run: |
          echo "üîß Agregando archivos del modelo con FORCE..."
          
          # Agregar carpeta completa del modelo
          git add -f ADAUSD_MODELS/ || echo "‚ö†Ô∏è Error en ADAUSD_MODELS/"
          git add -f ADAUSD_MODELS/*.pth || echo "‚ö†Ô∏è Error en .pth"
          git add -f ADAUSD_MODELS/*.pkl || echo "‚ö†Ô∏è Error en .pkl"
          git add -f ADAUSD_MODELS/*.json || echo "‚ö†Ô∏è Error en .json"
          
          # Agregar archivos espec√≠ficos
          git add -f ADAUSD_1h_data.csv || echo "‚ö†Ô∏è Error en CSV"
          git add -f adausd_results.png || echo "‚ö†Ô∏è Error en PNG"
          git add -f LAST_TRAINING.txt || echo "‚ö†Ô∏è Error en LAST_TRAINING"
          git add -f .gitignore || echo "‚ö†Ô∏è Error en .gitignore"
          
          echo ""
          echo "üìã Estado de Git:"
          git status
          
          echo ""
          echo "üìù Archivos staged:"
          git diff --staged --name-only
      
      - name: üíæ Commit y Push
        run: |
          # Verificar si hay archivos para commitear
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è No hay archivos staged - nada que commitear"
            
            echo ""
            echo "üîç Diagn√≥stico:"
            echo "Archivos tracked por Git:"
            git ls-files | grep -E "(ADAUSD|adausd)" || echo "Ninguno"
            
            echo ""
            echo "Archivos ignorados:"
            git status --ignored | grep -E "(ADAUSD|adausd)" || echo "Ninguno"
            
            exit 1
          fi
          
          # Contar archivos
          FILES_COUNT=$(git diff --staged --name-only | wc -l)
          FILES_SIZE=$(git diff --staged --shortstat | grep -oP '\d+(?= file)' || echo "0")
          
          echo "üìä Archivos a commitear: $FILES_COUNT"
          
          # Commit
          git commit -m "üîß Force commit model files [$(date +'%Y-%m-%d %H:%M UTC')]

‚úÖ Archivos incluidos:
$(git diff --staged --name-only)

Total: $FILES_COUNT archivos
"
          
          # Push
          git push origin main
          
          echo ""
          echo "‚úÖ ¬°Archivos guardados exitosamente!"
      
      - name: üì± Notificar resultado
        if: always()
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            FILES=$(git diff HEAD~1 --name-only | wc -l)
            COMMIT=$(git log -1 --pretty=format:"%h - %s")
            
            MSG="‚úÖ *Archivos del Modelo Guardados*%0A%0A"
            MSG="${MSG}Archivos: ${FILES}%0A"
            MSG="${MSG}Commit: ${COMMIT}%0A%0A"
            MSG="${MSG}Los archivos ahora est√°n en GitHub"
          else
            MSG="‚ùå *Error guardando archivos*%0A%0A"
            MSG="${MSG}Revisa los logs en GitHub Actions"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_API}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MSG}" \
            -d parse_mode="Markdown" || echo "‚ö†Ô∏è Telegram notification failed"
