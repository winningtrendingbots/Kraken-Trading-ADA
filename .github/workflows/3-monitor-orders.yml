name: ğŸ‘€ Monitor Orders

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Check for open orders
        id: check
        run: |
          echo "ğŸ” Verificando Ã³rdenes abiertas..."
          
          # Verificar open_orders.json
          if [ -f "open_orders.json" ]; then
            # Contar Ã³rdenes usando Python
            order_count=$(python3 << 'PYEOF'
          import json
          try:
              with open('open_orders.json', 'r') as f:
                  data = json.load(f)
                  print(len(data))
          except:
              print(0)
          PYEOF
          )
            
            if [ "$order_count" -gt 0 ]; then
              echo "ğŸ“Š Ã“rdenes abiertas: $order_count"
              echo "has_orders=true" >> $GITHUB_OUTPUT
            else
              echo "ğŸ”­ No hay Ã³rdenes abiertas"
              echo "has_orders=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ”­ Archivo open_orders.json no existe"
            echo "has_orders=false" >> $GITHUB_OUTPUT
          fi
          
          # Verificar orders_executed.csv
          if [ -f "orders_executed.csv" ]; then
            lines=$(wc -l < orders_executed.csv)
            echo "ğŸ“‹ Ã“rdenes ejecutadas histÃ³ricas: $((lines - 1))"
          fi
      
      - name: ğŸ Setup Python
        if: steps.check.outputs.has_orders == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.check.outputs.has_orders == 'true'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ‘€ Monitor and close orders
        if: steps.check.outputs.has_orders == 'true'
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ğŸ‘€ Monitoreando Ã³rdenes abiertas..."
          
          # Ejecutar script de monitoreo
          python monitor_orders.py
      
      - name: ğŸ’¾ Save changes
        if: steps.check.outputs.has_orders == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # AÃ±adir archivos modificados
          git add open_orders.json 2>/dev/null || true
          git add kraken_trades.csv 2>/dev/null || true
          git add orders_executed.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No hay cambios para guardar"
          else
            timestamp=$(date -u +"%H:%M UTC")
            git commit -m "ğŸ‘€ Orders monitored: $timestamp"
            git push
            echo "âœ… Cambios guardados"
          fi
      
      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "${{ steps.check.outputs.has_orders }}" = "true" ]; then
            echo "âœ… Monitoreo ejecutado"
            echo "   - Ã“rdenes verificadas"
            echo "   - Precios checkeados"
            echo "   - TP/SL evaluados"
          else
            echo "â³ Sin Ã³rdenes activas"
            echo "   - Esperando nuevas seÃ±ales"
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
